---
title: "Untitled"
output:
  html_document: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "../figures/",
  fig.retina = TRUE,
  # fig.height = 3,
  dev = "png",
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)
library(mesoda)
library(metR)
library(tidyverse)
library(lubridate)
library(data.table)
library(here)
library(patchwork)
library(unglue)
library(knitr)
library(kableExtra)
library(tagger)

map_arg <- rnaturalearth::ne_states(country = c("argentina"), 
                                    returnclass = "sf")
map_limitrofes <- rnaturalearth::ne_countries(country = c("Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

square <- fread(here("analysis", "data", "derived_data", "dominio_square.csv"))
square2 <- fread(here("analysis", "data", "derived_data", "dominio_square2.csv"))
coord <- fread(here("analysis", "data", "derived_data", "coordenadas.csv"))


geom_mapa <- function(fill = NA) {
  list(geom_sf(data = map_arg, fill = fill, color = "black", size = 0.1, inherit.aes = FALSE),
       geom_sf(data = map_limitrofes, fill = fill, color = "black", size = 0.1, inherit.aes = FALSE),
       coord_sf(ylim = c(-42, -19), xlim = c(-76, -51)),
       scale_x_longitude(ticks = 5),
       scale_y_latitude(ticks = 5))
}

arg_topo <- metR::GetTopography(-75+360, -50+360, -20, -60, resolution = 1/10)
arg_topo[, lon := metR::ConvertLongitude(lon)]

cordillera <- list(
  ggnewscale::new_scale_fill(),
  geom_contour_fill(data = arg_topo, aes(x = lon, y = lat, 
                                         z = h),
                    breaks = seq(1500, 8000, by = 700)),
  scale_fill_gradient(low = "#E2E6E6", high = "#7E7E7E", guide = "none",
                      oob = scales::squish))

scale_date <- function(ini = 20181120180000, end = 20181123120000,
                       break_bin = "6 hour") {
  scale_x_datetime(breaks = seq.POSIXt(ymd_hms(ini), ymd_hms(end), by = break_bin),
                   labels = function(x) {
                     fifelse(hour(x) == 0, format(x, "%H\n%b %d"), format(x, "%H"))
                   }) 
}

obs.type <- tribble(
  ~type, ~code,
  120, "ADPUPA",
  130, "AIRCFT-AIREP",
  131, "AIRCFT-AMDAR",
  133, "AIRCAR",
  180, "SFCSHP",
  181, "ADPSFC",
  187, "ADPSFC\nno pressure",
  220, "ADPUPA",
  221, "ADPUPA-PIBAL",
  230, "AIRCFT-AIREP",
  231, "AIRCFT-AMDAR",
  233, "AIRCAR",
  280, "SFCSHP",
  281, "ADPSFC",
  287, "ADPSFC\nno pressure",
  290, "ASCATW"
) %>% 
  setDT()

fisica <- data.table(mem = as.character(formatC(1:60, flag = "0", width = 3)),
                     fisica = rep(c("KF-YSU", 
                                    "BMJ-YSU",
                                    "GF-YSU",
                                    "KF-MYJ",
                                    "BMJ-MYJ",
                                    "GF-MYJ",
                                    "KF-MYNN2",
                                    "BMJ-MYNN2",
                                    "GF-MYNN2"), length.out = 60)) %>% setDT()

multiespectrales <- c("airs_aqua",
                      "iasi_metop-a",
                      "iasi_metop-b")

experiments <- c("E4", "E5", "E6", "E7")
#Color blind friendly but E4 y E7 parecidos en Desaturated
colores_exp <- c(E2 = "#0077BB", E5 = "#88CCEE", E6 = "#EE7733", E8 = "#CC3311") 
# colores_exp <- c(E4 = "#225555", E5 = "#CCBB44", E6 = "#CC6677", E7 = "#882255")
satinfo <- fread(here("analysis", "data", "derived_data", "satinfo.txt")) %>% 
  setnames(c("!sensor/instr/sat", "chan"), c("sensor", "channel"))
derived_data <- "/home/paola.corrales/datosmunin/EXP/derived_data/"

```

## Introduction

## Data and Methods

```{r dominio, fig.cap="Figure 1. a) The horizontal domain used on the simulations (black box) and the inner domain used for the experiment comparison (red box) and the locations of Automatic Surface Weather Stations (ASWS, green squares) and Conventional Surface Weather Stations (CSWS, orange triangles) . b) Locations of radiosonde launches during the experiment. The topography in meters is also shown (filled contours).", fig.height=5}

oficiales <- fread(here("analysis", "data", "raw_data", "E2_asim_conv_20181121120000.ensmean"), 
                   na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
  .[, c("V2", "V4") := NULL] %>% 
  setnames(colnames(.), c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr")) %>% 
  .[type %in% c(181, 281)] %>% unique(by = c("stationID")) %>%
  .[!str_detect(stationID, pattern = "[A-Z]")] %>% 
  .[, source := "Sfc - Official"]

no_oficiales <- fread(here("analysis", "data", "raw_data", "E5_asim_conv_20181121120000.ensmean"), 
                      na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
  .[, c("V2", "V4") := NULL] %>% 
  setnames(colnames(.), c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr")) %>% 
  .[type %in% c(181, 187)] %>% 
  .[!str_detect(stationID, "SMN")] %>%
  .[!(stationID %in% oficiales$stationID)] %>% 
  unique(by = c("stationID")) %>% 
  .[, source := "Sfc - Non-official"]

obs <- rbind(no_oficiales, oficiales)

lista_sondeos <- fread(here("analysis/data/derived_data/lista_sondeos.csv")) %>% 
  .[, periodo := fcase(nominal_launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")),  "IOP07", 
                       nominal_launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")),  "IOP08", 
                       default = "Others")
  ]

dominio <- fread(here("analysis", "data", "derived_data", "dominio_hgt.csv")) %>% 
  .[, c("x", "y") := wrf_project(lon, lat)]

dominio %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  scale_fill_gradient(low = "#f2f2f2", high = "#333333",
                      name = NULL,
                      breaks = seq(0, 6000, 1000),
                      guide = guide_colorstrip(barwidth = 20,
                                               barheight = 0.8)) +
  geom_mapa() +
  geom_point(data = obs, aes(ConvertLongitude(lon), lat, 
                             color = source, shape = source), 
             size = 1, alpha = 0.8) + 
  scale_shape_manual(name = "a) Surface stations",  
                     breaks = c("Sfc - Non-official", "Sfc - Official"),
                     labels = c("ASWS","CSWS"), values = c(15, 17),
                     guide = guide_legend(override.aes = list(size = 2))) +
  scale_color_manual(name =  "a) Surface stations", 
                     values = c("Sfc - Non-official" = "#00695c", 
                                "Sfc - Official" = "#FD8002"),
                     breaks = c("Sfc - Non-official", "Sfc - Official"),
                     labels = c("ASWS","CSWS"),
                     guide = guide_legend(override.aes = list(size = 2))) +
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  geom_point(data = square2, aes(lon, lat), size = 0.2, color = "#CC3311") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "vertical") +
  # ,
  # legend.margin = margin(),
  # legend.box.spacing = margin(0, 0, 0, 0)) +
  # 
  dominio %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  scale_fill_gradient(low = "#f2f2f2", high = "#333333",
                      name = NULL,
                      breaks = seq(0, 6000, 1000),
                      guide = guide_colorstrip(barwidth = 20,
                                               barheight = 0.8)) +
  geom_mapa() +
  coord_sf(ylim = c(-35.5, -29), xlim = c(-66.5, -61.5)) +
  geom_jitter(data = lista_sondeos, aes(lon, lat, 
                                        color = periodo,
                                        shape = periodo), 
              alpha = 0.5, size = 1.5, width = 0.03, height = 0.03) +
  scale_color_brewer(palette = "Dark2",
                     guide = guide_legend(override.aes = list(size = 2,
                                                              alpha = 1))) +
  labs(color = "b) Soundings", shape = "b) Soundings") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "vertical") +
  # ,
  #         legend.margin = margin(),
  #         legend.box.spacing = margin(0, 0, 0, 0)) +
  plot_layout(ncol = 2, guides = "collect") +
  plot_annotation(tag_levels = 'a', tag_suffix = ')') & 
  theme(legend.position = 'bottom', legend.box = "vertical")
```

```{r ciclo, fig.cap="Diagram of analysis cycles between Nov 20th, 18 UTC and Nov 23rd 12 UTC plus and spin up period of 6 hours. The zoomed figure shows assimilation in one-hour centered window and new boundary conditions from GFSD every 6 hours.", out.height=400, out.width=800, fig.align="center"}
knitr::include_graphics(here("analysis", "figures", "analysis_cycle.svg"))
```

```{r obs}
tribble(
  ~obs_type, ~conv, ~aut, ~satwnd, ~rad,
  "PREPBUFR", "x", "x", "x", "x",
  "AUTSFC", " ", "x", "x", "x",
  "SATWND", " ", " ", "x", "x",
  "RAD", " ", " ", " ", "x",
) %>% 
  kbl(col.names = c("Obs type", "CONV", "AUT", "SATWND", "RAD"),
      caption = "Observation types assimilated in each experiment.") %>% 
  kable_classic_2(full_width = F)
```


```{r count_obs, fig.height=6, fig.width=10}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E2/ANA/*/diagfiles/asim*ensmean")[1:67]

conv <- read_diag_conv(files, exp = "E2", member = "000") 

conv[, bufr_code := fcase(type %in% c(181, 187, 281, 287), "ADPSFC",
                          type %in% c(120, 220, 221), "ADPUPA",
                          type %in% c(130, 131, 133, 230, 231, 233), "AIRCFT",
                          type %in% c(290), "ASCATW",
                          type %in% c(180, 280, 183, 283, 184, 284), "SFCSHP",
                          type %in% c(240:260), "SATWND")] %>% 
  .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
           lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))] 


files <- files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E5/ANA/*/diagfiles/asim*ensmean")[1:67]

aut <- read_diag_conv(files, exp = "E5", member = "000") 

aut[, bufr_code := fcase(type %in% c(181, 187, 281, 287), "ADPSFC",
                         type %in% c(120, 220, 221), "ADPUPA",
                         type %in% c(130, 131, 133, 230, 231, 233), "AIRCFT",
                         type %in% c(290), "ASCATW",
                         type %in% c(180, 280, 183, 283, 184, 284), "SFCSHP",
                         type %in% c(240:260), "SATWND")] %>% 
  .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
           lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))] 

files <- files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E6/ANA/*/diagfiles/asim*ensmean")[1:67]

satwnd <- read_diag_conv(files, exp = "E6", member = "000") 

satwnd[, bufr_code := fcase(type %in% c(181, 187, 281, 287), "ADPSFC",
                            type %in% c(120, 220, 221), "ADPUPA",
                            type %in% c(130, 131, 133, 230, 231, 233), "AIRCFT",
                            type %in% c(290), "ASCATW",
                            type %in% c(180, 280, 183, 283, 184, 284), "SFCSHP",
                            type %in% c(240:260), "SATWND")] %>% 
  .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
           lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))] 


p1 <- rbind(conv, aut, satwnd) %>% 
  .[usage.flag == 1 & rerr != 1.0e+10] %>% 
  .[, .(count_obs = .N), by = .(exp, lon.box, lat.box, date)] %>% 
  .[, .(obs_cycle = mean(count_obs, na.rm = TRUE)), by = .(exp, lon.box, lat.box)] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = obs_cycle), alpha = 0.8) +
  scale_fill_viridis_c(option = "D", trans = scales::log10_trans(),
                       guide = guide_colorbar(barwidth = 20)) +
  geom_mapa() +
  facet_wrap(~exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                               E6 = "SATWND", E8 = "RAD"))) +
  labs(fill = "Mean number of\nobs per cycle") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

p2 <- rbind(conv, aut, satwnd) %>% 
  .[usage.flag == 1 & rerr != 1.0e+10] %>% 
  .[, ":="(lev.box = cut_round(pressure, breaks = seq(50, 1050, 50)))] %>% 
  .[, .(count_obs = .N), by = .(exp, lev.box, date)] %>% 
  .[, .(obs_cycle = mean(count_obs, na.rm = TRUE)), by = .(exp, lev.box)] %>% 
  ggplot(aes(lev.box, obs_cycle)) +
  geom_line(aes(color = exp)) +
  geom_point(aes(color = exp, shape = exp), size = 2) +
  scale_color_manual(values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E8 = "RAD")) +
  scale_shape_manual(values = c(15, 16, 17), labels = c(E2 = "CONV", E5 = "AUT", 
                                                        E6 = "SATWND", E7 = "RAD")) +
  # geom_tile(aes(fill = obs_cycle)) +
  # scale_fill_viridis_c(option = "D", trans = scales::log10_trans(),
  #                      guide = guide_colorbar(barheight = NULL)) +
  scale_y_log10() +
  scale_x_reverse() +
  coord_flip() +
  labs(color = NULL, shape = NULL,
       x = "Pressure level (hPa)", y = "Mean number of\nobs per cycle") +
  theme_minimal() +
  theme(aspect.ratio = 2.5/1, 
        legend.position = "bottom",
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

p3 <- rbind(conv, aut, satwnd) %>% 
  .[usage.flag == 1 & rerr != 1.0e+10] %>% 
  .[, .(count_obs = .N), by = .(exp, date)] %>% 
  ggplot(aes(date, count_obs)) +
  geom_line(aes(color = exp)) +
  geom_point(aes(color = exp, shape = exp), size = 2) +
  scale_color_manual(values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E7 = "RAD")) +
  scale_shape_manual(values = c(15, 16, 17), labels = c(E2 = "CONV", E5 = "AUT", 
                                                        E6 = "SATWND", E7 = "RAD")) +
  scale_date() +
  labs(y = "Number of obs per cycle", x = NULL,
       color = NULL, shape = NULL) +
  theme_minimal() +
  theme(aspect.ratio = 1/2,
        legend.position = "bottom", 
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

cowplot::plot_grid(p1, NULL, p2, p3, ncol = 3,  rel_widths = c(1.3, -0.3, 1))

```



```{r}
files <- Sys.glob(here("analysis/data/derived_data/count_obs_E*"))[c(1, 3, 4)]

purrr::map(files, ~fread(.x)) %>% rbindlist() %>% 
  .[, porcentaje := scales::percent(proporcion, accuracy = 0.01, trim = TRUE)] %>% 
  dcast(bufr_code ~ exp, value.var = "porcentaje") %>% 
  .[order(.[,'bufr_code']), ] %>% 
  kbl(col.names = c("Obs type", "CONV", "AUT", "SATWND")) %>% 
  kable_classic_2(full_width = F)

purrr::map(files, ~fread(.x)) %>% rbindlist() %>% 
  # .[, porcentaje := scales::percent(proporcion, accuracy = 0.01, trim = TRUE)] %>% 
  dcast(bufr_code ~ exp, value.var = "N") %>% 
  .[order(.[,'bufr_code']), ] %>% 
  kbl(col.names = c("Obs type", "CONV", "AUT", "SATWND")) %>% 
  kable_classic_2(full_width = F)
```




```{r}
fread(here("analysis", "data", "derived_data", "tabla_radianzas.csv")) %>% 
  .[, ":="(sensor = toupper(sensor),
           plataforma = toupper(plataforma),
           prop = scales::percent(prop/100, accuracy = 0.01, trim = TRUE))] %>% 
  .[order(.[,'sensor']), ] %>% 
  .[] %>% 
  kbl(col.names = c("Sensor", "Plataform", "Number of assimilated\nchannels", "Percentage over total"),
      caption = "List of the available sensors in several platforms, the number of accepted channels and the percentage of assimilated observations calculated over all radiance observations.") %>% 
  collapse_rows(1,valign = "top") %>% 
  # column_spec(1, width = "3cm", latex_valign = "p") %>% 
  kable_classic_2(full_width = F)
```


```{r rad, fig.cap="Number of radiance observations for each 50 hPa pressure layer over time"}

files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E8/ANA/*/diagfiles/asim*ensmean")

files <- files[!str_detect(files, "conv")]


rad <- read_diag_rad(files, "E8") %>% 
  satinfo[., on = c("sensor", "channel")]

rad %>% 
  .[qc == 0 & iuse == 1] %>% 
  .[, lev := factor(cut_round(peakwt, breaks = seq(0, 1050, 50)))] %>% 
  .[, .(omb = mean(tbc),
        n = .N), by = .(date, lev)] %>% 
  .[lev != 1025] %>% 
  ggplot(aes(date, fct_rev(lev))) +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c(trans = scales::log10_trans(), breaks = c(1, 10, 100, 1000, 10000),
                       guide = guide_colourbar(barheight = 18,
                                               barwidth = 0.8)) +
  
  scale_date() +
  labs(x = NULL, fill = NULL, y = "pressure (hPa)") +
  theme_minimal()

```
```{r level-rad, fig.cap="Nivel de presión asociado a las observaciones en cada ciclo de asimilación"}

rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[sensor %in% c("airs", "iasi") &
      # errinv %between% c(0.0000316227, 1000) & 
      # qc == 0 & 
      # iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  .[, as.list(quantile(peakwt, c(0.05, 0.5, 0.95))) %>% setNames(c("Q5", "Q50", "Q95")), by = .(sensor, channel)] %>% 
  ggplot(aes(channel, Q50)) +
  # geom_boxplot(aes(group = factor(channel)), outlier.color = "darkorange", 
  #             outlier.size = 0.5, size = 0.1) +
  geom_ribbon(aes(ymin = Q5, ymax = Q95), alpha = 0.4, fill = "darkorange") +
  geom_line(color = "darkorange") +
  scale_y_level(name = "Pressure (hPa)") +
  facet_wrap(~sensor, scales = "free", labeller = labeller(sensor = toupper)) +
  labs(x = "", y = "") +
  theme_minimal() +
  
  rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[!sensor %in% c("airs", "iasi") &
      # errinv %between% c(0.0000316227, 1000) & 
      # qc == 0 & 
      # iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  .[, as.list(quantile(peakwt, c(0.05, 0.5, 0.95))) %>% setNames(c("Q5", "Q50", "Q95")), by = .(sensor, channel)] %>% 
  ggplot(aes(channel, Q50)) +
  # geom_boxplot(aes(group = factor(channel)), outlier.color = "darkorange", 
  #             outlier.size = 0.5, size = 0.1) +
  geom_ribbon(aes(ymin = Q5, ymax = Q95), alpha = 0.4, fill = "darkorange") +
  geom_line(color = "darkorange") +
  scale_y_level(name = "Pressure (hPa)") +
  facet_wrap(~sensor, scales = "free", labeller = labeller(sensor = toupper)) +
  labs(y = "", x = "Channel index") +
  theme_minimal() +
  plot_layout(ncol = 1)
```


## Results

### Ensemble reliability

```{r rcrv-sfc, fig.cap="Standar deviation of rcrv calculate for surface observations included in boxes of 2.5 degree"}

rbind(fread(here("analysis", "data", "derived_data", "rcrv_V_box.csv")),
      fread(here("analysis", "data", "derived_data", "rcrv_t_box.csv"))) %>%   
  # .[var %in% c("u", "v") & type %in% c(281, 287)] %>% 
  .[, type.obs := type] %>% 
  .[, type.obs := fcase(type.obs == 181, 281,
                        type.obs == 187, 287,
                        type.obs == 281, 281,
                        type.obs == 287, 287)] %>% 
  .[, var := factor(var, levels = c("v", "t"))] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = sd.y)) +
  geom_mapa() +
  scale_fill_viridis_c(breaks = seq(0, 5, 0.5),
                       limits = c(0, 5),
                       direction = -1,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(var~type.obs, 
             labeller = labeller(type.obs = c("281" = "ADPSFC",
                                              "287" = "ADPSFC\n no pressure",
                                              "181" = "ADPSFC",
                                              "187" = "ADPSFC\n no pressure"),
                                 var = c("v" = "Wind",
                                         "t" = "Temperature"))) +
  tag_facets() +
  labs(fill = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```


```{r rcrv-profile, fig.cap="Profiles of the mean and standard deviation of RCRV for upper-air observations.", fig.subcap=c("Sounding and aircraft observations.", "Satellite-derived wind.", "Radiances observations.")}

rbind(fread(here("analysis", "data", "derived_data", "rcrv_V_perfil.csv")), 
      fread(here("analysis", "data", "derived_data", "rcrv_t_perfil.csv"))) %>% 
  obs.type[., on = "type"] %>%   
  .[type != 130] %>%
  melt(measure.vars = c("mean.y", "sd.y")) %>% 
  ggplot(aes(error.level, value)) +
  geom_hline(yintercept = c(0, 1), color = "grey20") +
  geom_line(aes(color = factor(code), linetype = variable)) +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("Mean RCRV", "SD RCRV")) +
  scale_x_level(breaks = c(1000, 500, 250, 125, 50)) +
  coord_flip() +
  facet_wrap(~ var, labeller = labeller(var = c("t" = "Temperature",
                                                "v" = "Wind"))) +
  tag_facets() +
  labs(y = NULL,
       linetype = "",
       color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "vertical",
        aspect.ratio = 2/1)


read_csv(here::here("analysis", "data", "derived_data", "rcrv_satwind.csv")) %>% 
  melt(measure.vars = c("mean.y", "sd.y")) %>%
  ggplot(aes(nivel.error, value)) +
  geom_hline(yintercept = c(0, 1), color = "darkgrey") +
  geom_line(aes(color = factor(sat_type), linetype = variable)) +
  scale_color_brewer(palette = "Set1") +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("Mean RCRV", "SD RCRV")) +
  scale_x_level(breaks = c(1000, 500, 250, 125, 50)) +
  coord_flip() +
  facet_wrap(~ var, scales = "free_x", labeller = labeller(var = c("u" = "U wind",
                                                                   "v" = "V wind"))) +
  labs(linetype = NULL,
       color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "vertical",
        aspect.ratio = 2/1)

files <- Sys.glob("/home/paola.corrales/mesoda/analysis/data/derived_data/rcrv_*_perfil.csv")[1:6]

RCRV <- purrr::map(files, function(f) {
  meta <- unglue::unglue(basename(f), "rcrv_{sensor}_perfil.csv")
  
  fread(f) %>%
    .[, sensor := meta[[1]][["sensor"]]]
}) %>%
  rbindlist()

RCRV %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  setDT() %>% 
  melt(measure.vars = c("mean.y", "sd.y")) %>% 
  .[, .(value = mean(value, na.rm = TRUE)), by = .(sensor, level, variable)] %>% 
  ggplot(aes(level, value)) +
  geom_hline(yintercept = c(0, 1), color = "grey20") +
  geom_line(aes(color = sensor, linetype = variable)) +
  scale_color_discrete(labels = toupper) +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("Mean RCRV", "SD RCRV")) +
  coord_flip() +
  scale_x_level(breaks = c(1000, 500, 250, 125, 50)) +
  labs(x = NULL, y = NULL,
       color = NULL, linetype = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "vertical",
        aspect.ratio = 2/1)


```

### Impacts of assimilated observations 


```{r TQ-diff, fig.cap="Difference between experiments for the average vertical profile of variables over time.", fig.scap=c("Temperature (°C).", "Specific Humidity (g/kg)."), fig.height=3.5}
files <- list.files(derived_data, recursive = TRUE, full.names = TRUE,
                    pattern = "perfiles_ana")

perfiles <- purrr::map(files, function(f) {
  exp <- unglue(basename(f), "perfiles_{run}_{exp}.csv")
  fread(f) %>% 
    .[, exp := exp[[1]][["exp"]]]
  
}) %>% 
  rbindlist() %>% 
  .[, date := as_datetime(date)] %>% 
  .[date %between% c(as_datetime("2018-11-20 18:00:00"),
                     as_datetime("2018-11-23 12:00:00"))]


perfiles %>% 
  dcast(lev + date ~ exp, value.var = "T") %>% 
  .[, ":="(E5_E2 = E5 - E2,
           E6_E5 = E6 - E5,
           E8_E6 = E8 - E6)] %>% 
  melt(measure.vars = c("E5_E2", "E6_E5", "E8_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)),
                    breaks = c(seq(-2, 2, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  labs(fill = "Temperature (K)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E5_E2" = "AUT - CONV",
                                              "E6_E5" = "SATWND - AUT",
                                              "E8_E6" = "RAD - SATWND"))) +
  tag_facets(position = list(x = 0.1, y = 0.96)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 


perfiles %>% 
  dcast(lev + date ~ exp, value.var = "QVAPOR") %>% 
  .[, ":="(E5_E2 = E5 - E2,
           E6_E5 = E6 - E5,
           E8_E6 = E8 - E6)] %>% 
  melt(measure.vars = c("E5_E2", "E6_E5", "E8_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value*1000, fill = stat(level)), 
                    breaks = c(seq(-1.6, 1.6, 0.2), Inf)) +
  scale_fill_divergent_discretised(limits = c(-1.6, 1.6),
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  labs(fill = "Specific humidity (g/Kg)",
       y = NULL,
       x = NULL) +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E5_E2" = "AUT - CONV",
                                              "E6_E5" = "SATWND - AUT",
                                              "E8_E6" = "RAD - SATWND"))) +
  tag_facets(tag_pool = c("d", "e", "f"), position = list(x = 0.1, y = 0.96)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

```{r UV-diff, fig.cap="Difference between experiments for the average vertical profile of wind over time (shaded) and U and V (only northerly wind) profiles for the experiment with more observations (contours).", fig.height=3.5}
perfiles %>% 
  dcast(lev + date ~ exp, value.var = "U") %>% 
  .[, ":="(E5_E2 = E5 - E2,
           E6_E5 = E6 - E5,
           E8_E6 = E8 - E6)] %>% 
  melt(measure.vars = c("E5_E2", "E6_E5", "E8_E6")) %>% 
  ggplot(aes(date, lev)) +
  # geom_contour(aes(z = value)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), breaks = c(seq(-2, 2, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  geom_contour2(data = ~.x[, .(lev, date, E5_E2 = E5, E6_E5 = E6, E8_E6 = E8)] %>%
                  melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value),
                breaks = seq(0, 30, 3), size = 0.2, linetype = 1, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E5_E2 = E5, E6_E5 = E6, E8_E6 = E8)] %>%
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value),
                    breaks = seq(0, 30, 3), color = "grey30", skip = 1,
                    size = 4, stroke = 0.1) +
  labs(fill = "U (m/s)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E5_E2" = "AUT - CONV",
                                              "E6_E5" = "SATWND - AUT",
                                              "E8_E6" = "RAD - SATWND"))) +
  tag_facets(position = list(x = 0.1, y = 0.96)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))


perfiles %>% 
  dcast(lev + date ~ exp, value.var = "V") %>% 
  .[, ":="(E5_E2 = E5 - E2,
           E6_E5 = E6 - E5,
           E8_E6 = E8 - E6)] %>% 
  melt(measure.vars = c("E5_E2", "E6_E5", "E8_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), 
                    breaks = c(-Inf, seq(-1.6, 1.6, 0.2), Inf)) +
  scale_fill_divergent_discretised(limits = c(-1.6, 1.6),
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  geom_contour2(data = ~.x[, .(lev, date, E5_E2 = E5, E6_E5 = E6, E8_E6 = E8)] %>% 
                  melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                breaks = seq(-9, 0, 1), size = 0.2, linetype = 2, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E5_E2 = E5, E6_E5 = E6, E8_E6 = E8)] %>% 
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                    breaks = seq(-9, 0, 1), color = "grey30", skip = 1, 
                    size = 4, stroke = 0.1) +
  labs(fill = "V (m/s)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E5_E2" = "AUT - CONV",
                                              "E6_E5" = "SATWND - AUT",
                                              "E8_E6" = "RAD - SATWND"))) +
  tag_facets(tag_pool = c("d", "e", "f"), position = list(x = 0.1, y = 0.96)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

```{r summary-fields, fig.cap="a) Precipitable water (shaded) and northerly wind (contours, m/s), b) Average potential temperature for the PBL and c) Maximum CAPE and ~0-6 km wind shear over 15 m/s and 30 m/s for each experiment. All fields correspond to 00 UTC Nov, 22.", fig.height=10, fig.width=9}

files <- Sys.glob(paste0(derived_data, "pw/*"))[c(1, 4, 5, 7)]

dates <- c("20181122000000")

pw <- purrr::map(files, function(f) {
  details <- unglue::unglue(basename(f), "pw_ana_{exp}_{date}.nc")[[1]]
  
  if (details$date %in% dates) {
    
    ReadNetCDF(f, vars = c(value = "pw", lon = "XLONG", lat = "XLAT")) %>% 
      .[, `:=`(exp = details$exp, 
               date = lubridate::ymd_hms(details$date))] %>%
      .[]
  }
}) %>% 
  rbindlist() %>% 
  .[, c("x", "y") := wrf_project(lon, lat)]

files <- Sys.glob(paste0(derived_data, "mucape/mcape_ana_E*_20181122000000.nc"))[c(1, 4, 5, 7)]

mucape <- purrr::map(files, function(f) {
  details <- unglue::unglue(basename(f), "mcape_ana_{exp}_{date}.nc")[[1]]
  
  if (details$date %in% dates) {
    
    ReadNetCDF(f, vars = c(value = "cape_2d", lon = "XLONG", lat = "XLAT")) %>% 
      .[, `:=`(exp = details$exp, 
               date = lubridate::ymd_hms(details$date))] %>%
      setnames(old = "mcape_mcin_lcl_lfc", new = "variable") %>% 
      .[]
  }
}) %>% 
  rbindlist() 

fcsts <- expand_grid(fcsts = c("20181122000000"),
                     exp = c("E2", "E5", "E6", "E8"))

ana <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0(derived_data, "/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0(derived_data, "/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, q := ReadNetCDF(paste0(derived_data, "/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR"), out = "vector")] %>% 
    .[, theta := ReadNetCDF(paste0(derived_data, "/theta_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(th = "theta"), out = "vector")] %>%
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist() 

cor <- ana[bottom_top %in% c(1, 16)] %>% 
  dcast(date + exp + south_north + west_east ~ bottom_top, value.var = c("u", "v")) %>% 
  .[, cortante := Mag(u_16 - u_1, v_16 - v_1)] %>% 
  .[, ":="(u_1 = NULL, 
           u_16 = NULL,
           v_1 = NULL,
           v_16 = NULL)]

ana[bottom_top %between% c(2, 7), .(v_mean = mean(v)), 
    by = .(south_north, west_east, date, exp)] %>% 
  .[pw, on = .NATURAL] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = value, fill = stat(level_d)),
                    proj = norargentina_lambert) +
  scale_fill_continuous_divergingx(super = ScaleDiscretised,
                                   palette = "PRGn", mid = 25,
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  geom_contour2(aes(z = v_mean, size = stat(level)),
                proj = norargentina_lambert, color = "black", 
                breaks = c(-10, -5)) +
  scale_size_continuous(breaks = c(-10, -5), range = c(0.8, 0.4),
                        labels = c("-10", "-5")) +
  # geom_text_contour(aes(z = v_mean), size = 3, stroke = 0.05,
  #                   proj = norargentina_lambert, color = "darkorange", 
  #              breaks = c(-10, -5), skip = 0,
  #              label.placement = label_placement_n(1)) +
  # scale_linetype_manual(guide = NULL, values = c(2, 1)) +
  labs(fill = "Precipitable\nwater (Kg/m²)", size = "V (m/s)") +
  cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E8 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  
  ana[bottom_top %between% c(2, 10), .(theta_mean = mean(theta)), 
      by = .(south_north, west_east, date, exp)] %>% 
  .[pw, on = .NATURAL] %>% 
  ggplot(aes(x, y)) +
  # geom_point(aes(color = v_mean)) +
  geom_contour_fill(aes(z = theta_mean, fill = stat(level_d)),
                    proj = norargentina_lambert,
                    breaks = c(-Inf, seq(290, 314, 2), Inf), limits = c(-Inf, Inf)) +
  scale_fill_distiller(super = ScaleDiscretised,
                       palette = "RdYlBu", direction = -1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  labs(fill = "Potential\ntemperature (K)") +
  cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E8 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.text = element_blank(), 
        strip.background = element_blank()) +
  
  
  mucape %>% 
  .[variable == "mcape"] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  .[cor, on = .NATURAL] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = value, fill = stat(level_d)), 
                    proj = norargentina_lambert, limits = c(500, 6000)) +
  scale_fill_distiller(super = ScaleDiscretised,
                       palette = "YlOrRd", direction = 1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  # geom_contour2(aes(z = cortante),
  #               proj = norargentina_lambert, color = "black", size = 0.4,
  #               breaks = c(10, 25)) +
  geom_contour2(aes(z = cortante, size = stat(level)),
                proj = norargentina_lambert, color = "black", 
                breaks = c(15, 30)) +
  scale_size_continuous(breaks = c(15, 30), range = c(0.8, 0.4),
                        labels = c("15", "30")) +
  # geom_point(data = ~.x[cortante >= 15 & is.cross(x, y, skip = 1)], 
  #            aes(x = lon, y = lat, 
  #                alpha = factor(cut_round(cortante, breaks = c(15, 25, Inf)))),
  #            size = 0.00002, shape = 20) +
  # scale_alpha_manual(values = c(0.3, 0.7), name = NULL, #labels = c(">5 m/s", ">15 m/s"),
  #                    guide = guide_legend(override.aes = list(size = 2))) +
  labs(fill = "MCAPE (J/Kg)", size = "Wind\nshear (m/s)") +
  cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E8 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(1, 1, 1, 1),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.text = element_blank(), 
        strip.background = element_blank()) +
  
  plot_layout(ncol = 1, heights = c(1, 1, 1)) +
  plot_annotation(tag_levels = "a", tag_suffix = ")")
```

```{r q_vert, fig.cap="Specific humidity (g/kg, shaded) and meridional wind (m/s, contours) average over the inner domain for each latitude for 00 UTC Nov, 22."}

coord <- mucape[variable == "mcape", c("south_north", "lat")] %>% 
  .[, .(lat = mean(lat)), by = south_north]

ana[west_east %between% c(70, 180) & bottom_top %between% c(1, 25)] %>% 
  .[, .(q_mean = mean(q),
        v_mean = mean(v)), by = .(bottom_top, south_north, date, exp)] %>% 
  coord[., on = "south_north"] %>% 
  ggplot(aes(lat, bottom_top)) +
  geom_contour_fill(aes(z = q_mean*1000, fill = stat(level_d))) +
  scale_fill_distiller(super = ScaleDiscretised,
                       palette = "BrBG", direction = 1,
                       # limits = c(1, 19),
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  geom_contour2(aes(z = v_mean, linetype = factor(-sign(..level..))), 
                color = "grey30", size = 0.3, binwidth = 2) +
  geom_text_contour(aes(z = v_mean), color = "grey30", 
                    size = 3, stroke = 0.05, breaks = seq(-10, 6, 2),
                    label.placement = label_placement_n(1)) +
  scale_linetype(guide = NULL) +
  scale_x_latitude(breaks = seq(-40, -20, 5)) +
  facet_wrap( ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                                 E6 = "SATWND", E8 = "RAD"))) +
  labs(y =  "Sigma levels", fill = "Specific\nhumidity (g/Kg)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```

### Verification

```{r pp-hov, fig.cap="Hövmoller of mean hourly accumulated precipitation for each latitude band observed (left) and simulated (right, for the ensemble mean) over the inner domain."}

files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/derived_data/ppacum/*ana*mean_acum_1h.rds")

ppacum_1h <- purrr::map(files, function(f) {
  
  readRDS(f) %>% 
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)]
  
}) %>% rbindlist() %>% 
  .[x %between% c(-300000, 800000) & y %between% c(-800000, 1090000)] 
}

readRDS("/home/paola.corrales/mesoda/analysis/data/derived_data/IMERG_1h.rds") %>% 
  .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
  .[x %between% c(-300000, 800000) & y %between% c(-800000, 1090000)] %>% 
  .[end_date %between% c(as_datetime("20181120190000"), as_datetime("20181123120000"))] %>% 
  .[, .(pp_acum = mean(pp_acum),
        lat = mean(lat),
        exp = "IMERG"), by = .(end_date, y)] %>% 
  ggplot(aes(end_date, lat)) +
  geom_contour_fill(aes(z = pp_acum, fill = stat(level)), breaks = c(seq(1, 13, 1), Inf)) +
  geom_contour2(aes(z = pp_acum), color = "black", size = 0.02, breaks = seq(1, 13, 1)) +
  # scale_fill_viridis_c(option = "A",
  scale_fill_distiller(palette = "YlGnBu",
                       direction = 1,
                       super = ScaleDiscretised,
                       guide = guide_colorsteps(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  scale_y_latitude(breaks = seq(-40, -20, 5)) +
  facet_wrap(~ exp) +
  labs(x = NULL, y = NULL, fill = "Acumulated\nprecipitation (mm/h)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  ppacum_1h %>% 
  .[exp %in% c("E2", "E5", "E6", "E8")] %>%
  .[, lat := lat[1], by = .(y)] %>% 
  .[, .(pp_acum = mean(pp_acum)), by = .(exp, date, y, lat)] %>% 
  ggplot(aes(date, lat)) +
  geom_contour_fill(aes(z = pp_acum, fill = stat(level)), breaks = c(seq(1, 13, 1), Inf)) +
  geom_contour2(aes(z = pp_acum), color = "black", size = 0.02, breaks = seq(1, 13, 1)) +
  # scale_fill_viridis_c(option = "A",
  scale_fill_distiller(palette = "YlGnBu",
                       direction = 1,
                       super = ScaleDiscretised,
                       guide = guide_colorsteps(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  scale_y_latitude(breaks = seq(-40, -20, 5), labels = NULL) +
  facet_wrap(~ exp, ncol = 4, labeller = labeller(exp = c(E2 = "CONV", E5 = "AUT", 
                                                          E6 = "SATWND", E8 = "RAD"))) +
  labs(x = NULL, y = NULL, fill = "Acumulated\nprecipitation (mm/h)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  plot_layout(ncol = 2, widths = c(0.2, 0.8), guides = "collect") & theme(legend.position = 'bottom')
```

```{r fss, fig.cap="FSS calculated over a 6-hours moving window for different thresholds and scales."}
files <- Sys.glob("/home/paola.corrales/mesoda/analysis/data/derived_data/fss_6h_ana_ens_E[2-8].csv")

fss <- purrr::map(files, function(f) {
  
  fread(f) %>% 
    .[, date := as_datetime(date)]
}) %>% 
  rbindlist()

fss %>% 
  .[w %in% c(1, 11) & q %in% c(1, 25) & exp %in% c("E2", "E5", "E6", "E8")] %>% 
  # .[date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  # geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E8 = "RAD")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  coord_cartesian(xlim = c(ymd_hms(20181122000000), ymd_hms(20181123120000))) +
  facet_grid(w~q, labeller = labeller(q = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"),
                                      w = c("1" = "10 km", "5" = "50 km", "11" = "100 km", 
                                            "51" = "500 km", "101" = "1000 km"))) +
  labs(color = NULL, x = NULL, y = "FSS") +
  theme_minimal()
```

```{r soundings, fig.cap="RMSE and Bias of temperature, dew point temperature and wind components calculated by comparing each experiment with the RELAMPAGO soundings during IOP 7 and IOP 8."}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/derived_data/sondeos/ANA/sondeo_E[2568]*")

sondeos <- purrr::map(files, function(f){
  
  fread(f) %>% 
    .[, value := fifelse(variable %in% c("t", "td"), value + 273.15, value)] %>% 
    .[, launch_time := as_datetime(launch_time)]
  
}) %>% 
  rbindlist()

IOP <- tribble(
  ~iop, ~ini, ~end,
  "IOP07", ymd_hms("20181121150000"), ymd_hms("20181121210000"),
  "IOP08", ymd_hms("20181122140000"), ymd_hms("20181122200000")
) %>% setDT()


sondeos %>% 
  .[, iop := fcase(launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")), "IOP07",
                   launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")), "IOP08")] %>% 
  .[variable %in% c("t", "td", "u", "v") & !str_detect(site, "/") & !is.na(fcst_value) & !is.na(iop)] %>% 
  .[site != "Sao Borja, Brazil"] %>% 
  .[, lev := cut_round(alt, c(seq(0, 3000, 500), seq(4000, 21000, 1000)))] %>% 
  .[, ":="(RMSE = mean(sqrt((value - fcst_value)^2), na.rm = TRUE), 
           BIAS = mean(value - fcst_value, na.rm = TRUE)), by = .(iop, exp, variable, lev)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est") %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = c(colores_exp, "black"), labels = c(E2 = "CONV", E5 = "AUT", 
                                                                  E6 = "SATWND", E8 = "RAD")) +
  coord_flip() +
  facet_grid(iop~variable, scales = "free_x", 
             labeller = labeller(variable = c("t" = "Temperature",
                                              "td" = "Dew point\ntemperature",
                                              "u" = "U wind",
                                              "v" = "V wind"))) +
  labs(y = NULL, x = "Height (Km)", color = NULL, linetype = NULL) +
  theme_minimal()
```


```{r dbz-mean}

rad_loc <- read_csv(here("analysis", "data", "derived_data", "radar_loc.csv"))

files <- Sys.glob("/home/jruiz/share/DATA/DATOS_RADAR/MOSAICO/*.nc")[seq(1, 12, 3)]
# Solo un par de horarios 10, 13, 16 y 19 UTC

dbz_obs <- purrr::map(files, function(f) {
  
  
  ReadNetCDF(f, vars = "DBZH_cor") %>%
    .[!is.na(DBZH_cor)] %>% 
    .[, .(DBZH_cor = max(DBZH_cor, na.rm = TRUE)), by = .(x, y)] %>% 
    .[, max_dbz := 10 * log10(DBZH_cor)] %>% 
    .[, ":="(date = ymd_hms(str_remove(basename(f), ".nc")),
             DBZH_cor = NULL)] %>% 
    .[, c("lon", "lat") := proj4::project(list(x, y), proj_radar, inverse = TRUE)]
  
}) %>% rbindlist() %>% 
  .[, run := "OBSERVATIONS"]

dates <- c("20181122100000", "20181122130000", 
           "20181122160000", "20181122190000")
files <- paste0(derived_data, "dbz/maxdbz_ana_E8_", dates, ".nc")

dbz_ana <- purrr::map(files, function(f){
  
  meta <- unglue(basename(f), "maxdbz_ana_{exp}_{date}.nc")
  ReadNetCDF(f, vars = c(lon = "XLONG", lat = "XLAT", "max_dbz")) %>% 
    .[, ":="(exp = meta[[1]][["exp"]],
             date = ymd_hms(meta[[1]][["date"]]))] %>% 
    .[, c("x", "y") := wrf_project(lon, lat)] 
}) %>% 
  rbindlist()  %>% 
  .[, run := "RAD"]

values <- c(-19.5, -12, -7.5, -3, 1.5, 6, 9, 12, 15, 16.5, 18, 19.5, 21, 
            22.5, 24, 25.5, 27, 28.5, 30, 31.5, 33, 34.5, 36, 37.5, 39, 40.5, 
            42, 43.5, 45, 46.5, 48, 49.5, 51, 52.5, 54, 55.5, 57, 58.5, 60, 
            61.5, 63, 64.5, 66, 69, 76.5)

colours <- c("#3D4170", "#3D4E7C", "#3B5B84", "#3A6695", "#3672A4", "#3188BD", 
             "#2F89B9", "#2896C7", "#24A4CF", "#2AB1D6", "#53F336", "#4BE231", 
             "#44D12F", "#3FC12B", "#3AAF25", "#32A11F", "#2C881E", "#227216", 
             "#EEEF39", "#DEE539", "#D7DA35", "#CED130", "#C4C52B", "#CBAE1F", 
             "#D59716", "#DB8116", "#EC0A2E", "#CB001A", "#C20013", "#B10009", 
             "#990000", "#C3005D", "#D600A2", "#E901E9", "#CC00CC", "#B100B5", 
             "#9800A0", "#FEFFFF", "#DFF5EC", "#C5F1E0", "#B7ECD8", "#A6ECCF", 
             "#95E3C5", "#85E0BD")


dbz_obs %>% 
  # .[date == unique(date)[1]] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = max_dbz, fill = stat(level)), 
                    proj = proj_radar,
                    breaks = values) +
  scale_fill_manual(values = colours, 
                    labels = function(x) JumpBy(x, 3, fill = ""),
                    drop = FALSE, 
                    guide = guide_colorsteps(barwidth = 30, 
                                             barheight = 0.8)) +
  # geom_point(data = rad_loc, aes(lon, lat, color = factor(nradar)), size = 2) +
  geom_path(data = rad_loc, aes(lon, lat, group = ID), size = 0.4) +
  geom_mapa() +
  facet_grid(run ~ date) +
  labs(x = NULL, y = NULL, fill = "COLMAX (dBZ)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  dbz_ana %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = max_dbz, fill = stat(level)), 
                    proj = norargentina_lambert,
                    breaks = values) +
  scale_fill_manual(values = colours, 
                    labels = function(x) JumpBy(x, 3, fill = ""),
                    drop = FALSE, 
                    guide = guide_colorsteps(barwidth = 30, 
                                             barheight = 0.8)) +
    # geom_point(data = rad_loc, aes(lon, lat, color = factor(nradar)), size = 2) +
 geom_path(data = rad_loc, aes(lon, lat, group = ID), size = 0.4) +
  geom_mapa() +
  facet_grid(run ~ date) +
  labs(x = NULL, y = NULL, fill = "COLMAX (dBZ)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  plot_layout(ncol = 1, guides = "collect") & 
  theme(legend.position = 'bottom')

```





