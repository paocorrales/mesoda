---
title: "Coeficientes para la corrección de bias"
output: 
  bookdown::html_document2: default
  bookdown::pdf_document2: default
bibliography: mesoda_ref.bib
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "../figures/",
  fig.retina = TRUE,
  # fig.height = 3,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)
library(mesoda)
library(metR)
library(tidyverse)
library(lubridate)
library(data.table)
library(here)
library(patchwork)
library(unglue)
library(knitr)
library(kableExtra)

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")


geom_mapa <- function() {
  list(geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE),
       coord_sf(xlim = c(-76, -52), ylim = c(-41, -20)))
}

sensores <- c("amsua_n15",
              "amsua_n18",
              "amsua_n19",
              "amsua_metop-b",
              "amsua_aqua",
              "airs_aqua",
              "iasi_metop-a",
              "iasi_metop-b", 
              "hirs4_n19",
              "hirs4_metop-a",
              "hirs4_metop-b",
              "mhs_metop-a",
              "mhs_metop-b",
              "mhs_n18",
              "mhs_n19",
              "mhs_metop-a",
              "atms_npp",
              "atms_n20",
              "cris-fsr_npp",
              "cris-fsr_n20"
)
cyan <- rgb(0, 139, 139, maxColorValue = 255)
```

La correcta asimilación de observaciones de satélite, en particular radianzas, depende en gran medida de la estimación y corrección del bias asociado a cada observación. Si el bias no es corregido podría afectar el análisis y los pronósticos generados generando impactos negativos. 

Uno de los desafíos en la corrección de bias para asimilación regional es la cantidad de observaciones disponibles en cada ciclo de asimilación lo que depende a su vez de la ubicación y orbitas de los distintos satélites. En la región de Sudamérica los distintos satélites polares pasan una o dos veces por día y el dominio escaneado es variable. A esta restricción se suma la disminución de observaciones disponibles debido al límite superior de los modelos regionales.

El sistema GSI-LETKF incorpora un metodo de corrección de bias que estima y actualiza coeficientes $\beta_i$ que se aplican a una regresón lineal previo a la estimación del estado final o análisis [@miyoshi2010]. Esta estimación se calcula aplicando la ecuación:

$$ \delta\beta = (B_{\beta}^{-1} + PR^{-1})^{-1}PR^{-1}[y-H(x)-P^{T}\beta]$$

Esta formulación es equivalente a la utilizada por la versión variacional de GSI y análoga a la ecuación del cálculo del análisis con la inclusión de la corrección de bias. En la ecuación $\delta\beta$ se asume diagonal y sus elementos se inicializan con el valor 0.1 y luego de su estimación que se calcula de manera iterativa, los coeficientes son actualizados:

$$\beta = \beta_b+\delta \beta$$

La corrección del bias se calcula utilizanod una regresión lineal con $N$ predictores independientes $P_i(x)$ y sus correspondientes coeficientes $\beta_i$.

$$BC = \sum_{i=1}^{N} \beta_i P_i(x) $$

La corrección del bias luego es aplicada directamente sobre la innovación $y - H(x)$.

Los predictores utilizados para la corrección asociada al estado de la atmósferea en este sistema corresponden a:

* Global offset
* Zenit angle
* Cloud liquid water (CLW)
* Temperature lapse rate (TLR)
* Temperature lapse rate al cuadrado

Mientras que la corrección asociada al ángulo de observación utiliza un polinomio de grado N. 

El cálculo de CLW y TLR depende de cada sensor y se realiza como parte de las rutinas de GSI. 

De acuerdo a @zhu2019 los coeficientes utilizados en la corrección del bias deben ser entrenados durante un periodo largo de tiempo y muestra que este tiempo es variable para cada canal de cada sensor. Con esto en mente se propone el siguiente experimento para el entrenamiento de los coeficientes. 

### Diseño experimental

Distintos trabajos abordan el entrenamiento de los coeficientes de corrección de bias en dominios regionales donde la cobertura de observaciones satélitales no es homogenea de manera similar. Por ejemplo @schwartz2012 utiliza un "spin up" de una semana para el entrenamiento de los coeficientes utilizando un método variacional con ciclos de asimilación cada 6 horas en un dominio regional mientras que @liu2012 utiliza un método "offline" durante 3 meses para obtener coeficientes de corrección estables. En particular @zhu2019 propone un periodo de entrenamiento de 9 días utilizando un método variacional determina que es necesario repetir este periodo una vez más para obtener coeficientes estables. 

Para obtener coeficientes que permitan la correcta asimilación de observaciones de radianzas durante el periodo 18 UTC 20/11/2018 - 12 UTC 23/11/2018 se realizará asimilación continua entre las 18 UTC 11/11/2018 y las 12 UTC del 20/11/2018. 

En este periodo de entrenamiento se observaron distintos fenómenos de tiempo severo asociados a sistemas convectivos de mesoescala y periodos de menor actividad por lo que se espera que la variedad de condiciones atmósfericas favorescan el entrenamiento de coeficientes pese al corto periodo de tiempo (9 días). Para garantizar esto y siguiendo a @zhu2019 este entrenamiento se realizará dos veces. Para el primer ciclo de asimilación se utilizaron los coeficientes de corrección de bias utilizados por GFS para la misma hora con la intención de acelerar el entramiento en comparación con una inicialización desde "0". Al finalizar el primer período de asimilación (experimento pre-RAD1) los coeficientes resultantes del último ciclo son utilizados al comenzar el segundo periodo de asimilación en las mismas fechas (pre-RAD2). 

El experimento de asimilación se realizará en el dominio que se muestra en la Figura \@ref(fig:dominio) realizando ciclos contínuos a cada hora. El dominio tiene una reticula horizontal de 10 km y el tope del modelo en 50 hPa. En cada ciclo se incluyen las observaciones disponibles en la ventana de asimilación de 1 hora centrada en la hora del análisis incluyendo observaciones convencionales en el prepBUFR, observaciones de estaciones automáticas en el dominio, vientos derivados de satélite y radianzas de sensores en satélites polares listados en la Tabla \@ref(tab:sensores).


```{r dominio, fig.cap="Dominio horizontal del modelo", fig.height=4}
fread(here("analysis", "data", "derived_data", "dominio_hgt.csv")) %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  # geom_point(aes(color = hgt), size = 5) +
  scale_fill_distiller(name = NULL,
                       type = "seq",
                       palette = "RdYlGn",
                       direction = -1,
                       breaks = seq(0, 6000, 500),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.8)) +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, size = 0.5) +
  coord_sf(ylim = c(-41, -20), xlim = c(-75, -52.5)) +
  labs(
    x = "Longitude", 
    y = "Latitude") +
  theme_minimal() +
  theme(legend.position = "bottom") 
```

```{r sensores}
fread(here("analysis", "data", "derived_data", "satinfo.txt")) %>%
  setnames("!sensor/instr/sat", "sensor_plataforma") %>% 
  .[iuse == 1 & sensor_plataforma %in% sensores, .N, by = .(sensor_plataforma)] %>% 
  separate(col = sensor_plataforma, into = c("sensor", "plataforma"), sep = "_") %>% 
  arrange(sensor) %>% 
  kable(col.names = c("Sensor", "Plataforma", "N° de canales asimilables"),
        caption = "Lista de sensores con la cantidad de canales aceptados por GSI") %>% 
  collapse_rows(columns = 1, valign = "top")  %>% 
  kable_classic_2()
```

#### Radianzas

La información de radianzas provienen de los sensores AMSU-A, AIRS, MHS, AIRS, IASI, HIRS todos en satélites de orbita polar. Estas observaciones son parte del sistema de transferencia de datos que utiliza GFS disponibles cada 6 horas pero asimiladas en ciclos horarios utilizando las observaciones correspondientes a una ventana centrada en la hora del análisis.

Se utilizaron observaciones en aire claro (ver métodos para detectar nubles usado por GSI) y se aplicó un control de calidad específico para cada sensor a fin de rechazar observaciones erroneas. A si mismo para tener en cuenta la resolución de cada observación se aplicó un thining de 60 km. Este valor fue definido siguiendo la metodología de otros trabajos en el área (@zhu2016, @jones2020, @lin2017a, and @singh2016qms). 

En la Figura \@ref(fig:n-rad) se muestra la cantidad de observaciones potencialmente asimilables, es decir, que pasan el control de calidad del operador de las observaciones, para cada canal en cada ciclo de asimilación. Dejando de lado IASI que no se ve nada porque tiene más de 600 canales, se puede ver que en todo los casos hay outliers. Esto tiene que ver con que en cada ciclo solo hay disponibles observaciones de algunos sensores y no siempre la pasada del sensor coincide completamente con el dominio. Los momenos donde la cantidad de observaciones aumenta considerablemente coinciden con los momentos donde la pasada del satélite estaba centrada en el dominio. En general hay más observaciones en el rango infrarrojo tanto por las observaciones de los sensores multiespectrales (AIRS e IASI) como por el sensor HIRS que en general para todos los canales aporta mayor cantidad de observaciones. 

```{r}
files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA", 
                    pattern = "asim.", recursive = TRUE, 
                    full.names = TRUE)
files <- files[!str_detect(files, pattern = "conv")]

diag_rad <- purrr::map(files, function(f) {
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/{date_ana}/diagfiles/{file}" )
  read_diag_rad(f, exp = meta[[1]][["exp"]]) %>%
    .[press > 50 & qc == 0] %>% 
    .[]
  
}) %>%
  rbindlist()
```


```{r n-rad, fig.cap="Cantidad de observaciones potencialmene asimilables en cada ciclo de asimilación para el experimento pre-RAD1"}
diag_rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[sensor %in% c("airs", "iasi")] %>% 
  .[, .N, by = .(date, channel, sensor)] %>% 
  ggplot(aes(channel, N)) +
  geom_boxplot(aes(group = factor(channel)), color = "darkorange", size = 0.1) +
  facet_wrap(~sensor, scales = "free") +
  labs(x = "", y = "Observaciones por ciclo") +
  theme_minimal() +
  
  diag_rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[!(sensor %in% c("airs", "iasi"))] %>% 
  .[, .N, by = .(date, channel, sensor)] %>% 
  ggplot(aes(channel, N)) +
  geom_boxplot(aes(group = factor(channel)), color = "darkorange") +
  facet_wrap(~sensor, scales = "free") +
  labs(x = "Canal", y = "Observaciones por ciclo") +
  theme_minimal() +
  plot_layout(ncol = 1)

```

En cuanto a la altura de las observaciones (Figura \@ref(fig:level-rad)), determinada a partir del máximo de la función de peso, muchas observaciones de canales de todos los sensores menos MHS correspoenden a alturas por encima del tope del modelo (50 hPa). Respecto de observaciones en el rango de microondas el sensor ATMS aporta la mayor cantidad de observaciones en niveles medios y altos y lo mismo ocurre con AMSU-A. En cuanto a las observaciones en el infrarrojo AIRS aporta muchas observaciones entre superficie y 200 hPa mientras que los canales de HIRS4 con observaciones en niveles medios y bajos muestran un comportamiento más variane y aporta en general menos observaciones. 


TODO: ¿Qué está pasando con el nivel de presión de IASI? Hay una franja negra en 300 hPa que tiene pinta sospechosa. 


```{r level-rad, fig.cap="Nivel de presión asociado a las observaciones potencialmene asimilables en cada ciclo de asimilación para el experimento pre-RAD1"}
diag_rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[sensor %in% c("airs", "iasi")] %>% 
  ggplot(aes(channel, peakwt)) +
  geom_boxplot(aes(group = factor(channel)), color = "darkorange", size = 0.1) +
  scale_y_level(name = "Presión (hPa)") +
  facet_wrap(~sensor, scales = "free") +
  labs(x = "", y = "") +
  theme_minimal() +
  
  diag_rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[!(sensor %in% c("airs", "iasi"))] %>% 
  ggplot(aes(channel, peakwt)) +
  geom_boxplot(aes(group = factor(channel)), color = "darkorange") +
  scale_x_continuous() +
  scale_y_level(name = "Presión (hPa)") +
  facet_wrap(~sensor, scales = "free") +
  labs(x = "Canal") +
  theme_minimal() +
  plot_layout(ncol = 1)
```

### Evolución de los coeficientes de corrección.


El entrenamiento de los coeficientes varia sensor a sensor y canal a canal, de acuerdo a lo observado en la bibliografía el tiempo de entrenamiento necesario es variable en cada caso. Al mismo tiempo al ser asimilación regional y horaria podría afectar el tiempo que demora la estabilización de los coeficientes de corrección.  


```{r}
files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA",
                    pattern = "satbias_2", 
                    recursive = TRUE,
                    full.names = TRUE)

satbias <- map(files, function(f){
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/{date_ana}/satbias_enkf/satbias_{date}")
  read_satbias(f) %>% 
    as.data.table() %>% 
    .[, ":="(date = ymd_hms(meta[[1]][["date"]]),
             exp = meta[[1]][["exp"]])] 
  
}) %>% 
  rbindlist()

satbias <- satbias[sensor %in% sensores]

satinfo <- fread(here("analysis", "data", "derived_data", "satinfo.txt")) %>% 
  setnames(c("!sensor/instr/sat", "chan"), c("sensor", "channel"))

satbias <- satinfo[satbias, on = c("sensor", "channel")]

```

Por ejemplo en la Figura \@ref(fig:coef-amsua-n15) se muestra la evolución de algunos de los coeficientes de canales del AMSU-A en NOAA15 en linea llena para la primera semana de entrenamiento pre-RAD1 y en línea punteada para la segunda semana pre-RAD2. Al igual que @zhu2019 se observa que cada coeficiente se estabiliza a una velocidad distinta, por ejemplo el coeficiente de emisividad en el canal 8 si bien hacia el final de la semana 2 muestra un comportamiento similar a la semana 1, los valores no son tan cercanos mientras que el TLR tiene un comportamiento muy similar en casi todo el periodo. Lamentablemente @zhu2019 no muestra otros canales (solo canal 5) pero es esperable que cada uno muestre variaciones. 

En general algunos coeficientes para algunos canales no requieren casi entrenamiento mientras que a otros capaz les vendría bien una semanita más. 

[link a gráficos de todos los sensores y canales](https://www.dropbox.com/sh/a64be0ognp0js0a/AAC6r8AXAGZ45dNFdvF1r8AEa?dl=0)

```{r coef-amsua-n15, fig.cap="Coeficientes de corrección de bias en cada ciclo de asimilación para los canales 5 a 9 del sensor AMSU-A de NOAA-15.", fig.height=3}
this_sensor <- sensores[1]

satbias[sensor == this_sensor & iuse == 1] %>% 
  .[channel %in% c(5:9)] %>%
  melt(measure.vars = paste0("coeff", c(1, 3:5, 8))) %>% 
  ggplot(aes(date, value)) +
  geom_path(aes(color = variable, linetype = exp), size= 0.5) +
  scale_color_brewer(type = "qual", palette = "Dark2",
                     labels = c("coeff1" = "Offset",
                                "coeff3" = "CLW",
                                "coeff4" = "TLR^2",
                                "coeff5" = "TLR",
                                "coeff8" = "Emiss")) +
  scale_linetype_discrete(name = "", labels = c("pre-RAD1", "pre-RAD2")) +
  scale_x_datetime(date_labels = "%d") +
  labs(title = paste("Coeficientes de", this_sensor),
       color = "", x = "Fecha", y = "") +
  facet_wrap(~channel, scales = "free_y", ncol = 5) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
Otro ejemplo se observa en la Figura \@ref(fig:coef-mhs-metop-a) correspondiente a los coeficientes el sensor MHS a bordo del satelite METOP-A. En este caso por ejemplo para el canal 3 se observa como el Offset se mantuvo aprximadamente constante luego de 6 días de entrenamiento mientras que el TLR en el canal 5 continua variando aún luego de la segunda semana. 


```{r coef-mhs-metop-a, fig.cap="Coeficientes de corrección de bias en cada ciclo de asimilación para los canales del sensor MHS en METOP-A.", fig.height=3}
this_sensor <- sensores[12]

satbias[sensor == this_sensor & iuse == 1] %>% 
  .[channel %in% c(1:5)] %>%
  melt(measure.vars = paste0("coeff", c(1, 3:5, 8))) %>% 
  ggplot(aes(date, value)) +
  geom_path(aes(color = variable, linetype = exp), size= 0.5) +
  scale_color_brewer(type = "qual", palette = "Dark2",
                     labels = c("coeff1" = "Offset",
                                "coeff3" = "CLW",
                                "coeff4" = "TLR^2",
                                "coeff5" = "TLR",
                                "coeff8" = "Emiss")) +
  scale_linetype_discrete(name = "", labels = c("pre-RAD1", "pre-RAD2")) +
  scale_x_datetime(date_labels = "%d") +
  labs(title = paste("Coeficientes de", this_sensor),
       color = "", x = "Fecha", y = "") +
  facet_wrap(~channel, scales = "free_y", ncol = 5) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### Corrección del bias

#### AMSU-A

Si observamos la corrección de bias para cada canal de la familia de sensores AMSU-A se ven diferencias interesantes entre los dos periodos pre-RAD1 y pre-RAD2. Para analizar estas diferencias en la Figura \@ref(fig:bias-amsua) hay que tener en cuenta que solo incluye las observaciones cumplen las condiciones para ser asimiladas y que este BIAS se obtiene de la diferencia entre la innovación con bias corregido y sin corregir. Por lo tanto este es el BIAS corregido por el sistema. Llama la atención que en muchos casos el BIAS durante el periodo pre-RAD2 tiene menor dispersión (menor rango intercuartil) y su mediana está más cerca de cero. Esto podría deberse a que a las observaciones que finalmente pasan el control de calidad requieren una menor corrección o que durante el periodo pre-RAD1 la corrección es sobreestimada.  

La evolución de bias a lo largo del tiempo para el sensor sobre NOAA15 (Figura \@ref(fig:bias-temp-amsua)) muestra cambios entre los dos periodos en algunos casos del orden de 0.5 grados. En general para los canales 7 y 8 los valores de bias en el periodo pre-RAD2 son algo menores respecto del otro periodo y en los casos donde esto no ocurre as diferencias son muy pequeñas. Esto coincide con lo que se observa en el panel superior derecho de la Figura \@ref(fig:bias-temp-amsua). 

```{r bias-amsua, fig.cap="Bias de las radianzas de AMSU-A en las distintas plataformas y para los dos periodos."}

files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA", 
                    pattern = "asim.", recursive = TRUE, 
                    full.names = TRUE)
files <- files[str_detect(files, pattern = "amsua")]

diag_rad <- purrr::map(files, function(f) {
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/{date_ana}/diagfiles/{file}" )
  read_diag_rad(f, exp = meta[[1]][["exp"]]) %>%
    .[]
  
}) %>%
  rbindlist()

diag_rad[sensor %in% sensores[1:5] & qc == 0] %>% 
  ggplot(aes(factor(channel), tbc - tbcnob)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_boxplot(aes(color = exp)) +
  scale_color_manual(values = c("darkorange", cyan), labels = c("pre-RAD1", "pre-RAD2")) +
  labs(x = "Canal", y = "BIAS corregido (K)",
       color = "") +
  facet_wrap(~sensor) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r bias-temp-amsua, fig.cap="Bias medio de las radianzas de AMSU-A NOAA 15 en las distintas plataformas y para los dos periodos a lo largo del tiempo. El tamaño de los puntos indica la cantidad de observaciones disponibles en cada momento.", fig.height=3, fig.width=6, fig.align="center"}

diag_rad[sensor %in% sensores[1] & qc == 0 & channel %in% c(6:8)] %>% 
  .[, .(mean_bias = mean(tbc - tbcnob, na.rm = TRUE),
        mean_mag_bias = mean(abs(tbc - tbcnob), na.rm = TRUE),
        n = .N), by = .(date, sensor, exp, channel)] %>% 
  ggplot(aes(date, mean_bias)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_line(aes(color = exp, group = interaction(exp, channel))) +
  geom_point(aes(color = exp, size = n)) +
  scale_color_manual(values = c("darkorange", cyan), labels = c("pre-RAD1", "pre-RAD2")) +
  scale_size_area(max_size = 4) +
  labs(x = "Canal", y = "BIAS corregido (K)",
       color = "", size = "") +
  facet_wrap(~channel) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

En la Figura \@ref(fig:bias-pred-amsua) se muestra la contribución de cada predictor a la corrección total de bias, o sea lo que resulta de $\beta_i P_i(x)$, sin tener en cuenta la corrección asociada al ángulo (TODO: no lo estoy sacando de los diag files originales, capaz debería hacerlo). En primer lugar comparando con el trabajo de @zhu2019 (Fig. 7) no se ve la variación casi cíclica pero esto muy posiblemente se deba a que en esos experimentos hay observaciones disponibles en cada ciclo de asimilación, lo que no ocurre en los que se presentan acá debido a la asimilación frecuente y al dominio que es más chico. En cuanto a valores, hay mayor similitud aún teniendo en cuenta las diferencias entre los distintos canales. 

Analizando específicamente los resultados de los experimentos, se ve que la contribución de cada predictor es distinta para los canales mostrados y además es distinta entre sensores. Por ejemplo Para el canal 5 del AMSU-A NOAA19 el predictor asociado a emisividad es el que más contribuye mientras que para NOAA18 el TLR^2 tambien contribuye. Esto se ve también en canal 7 donde a veces contribuye más el TLR, otras veces el TLR^2.

```{r bias-pred-amsua, fig.cap="Evolución temporal del bias asociado a cada predictor para los sensores AMSU-A en las distintas plataformas"}

diag_rad[qc == 0] %>% 
  .[, bias_total := pred1 + pred2 + pred3 + pred4 + pred5 + pred6 + pred7 + pred8] %>% 
  melt(measure.vars = c("pred1", "pred2", "pred3", "pred4", 
                        "pred5", "pred6", "pred7", "pred8", "bias_total")) %>% 
  .[, .(mean_bias = mean(value, na.rm = TRUE)), by = .(variable, date, exp, channel, sensor)] %>% 
  .[!(sensor %in% c("amsua_aqua", "amsua_metop-a")) & 
      channel %in% c(5:8) & variable %in% c("pred1", "pred3", "pred4", "pred5", "pred8", "bias_total")] %>% 
  ggplot(aes(date, mean_bias)) +
  geom_line(aes(color = variable, linetype = exp)) +
  scale_color_brewer(type = "qual", palette = "Dark2",
                     labels = c("pred1" = "Offset",
                                "pred3" = "CLW",
                                "pred4" = "TLR^2",
                                "pred5" = "TLR",
                                "pred8" = "Emiss")) +
  scale_linetype_discrete(name = "", labels = c("pre-RAD1", "pre-RAD2")) +
  facet_grid(channel~sensor, scales = "free") +
  labs(color = "", linetype = "",
       x = "", y = "BIAS predicho") +
  theme_minimal() +
  theme(legend.position = "bottom")


```

La distribución espacial de la corrección de bias aportada por distintos predictores para un tiempo particular se puede observar en la Figura \@ref(fig:pred-amsua). En este caso el TLR^2 muestra valores comparables con la literatura y en particular un máximo que ocupa gran parte del dominio. El predictor asociado a la emisividad presenta valores distinto de cero solo en la zona de topografía donde el nivel de presión de las observaciones está cerca de superficie. 

```{r pred-amsua, fig.cap="Contribución a la corrección del bias de dos predictores para el canal 8 de AMSU-A NOAA19 a las 8 UTC del 17/11/2018. Se incluyen observaciones que no pasaron el control de calidad."}

diag_rad[sensor == "amsua_n19" & date == as_datetime("2018-11-17 08:00:00") & channel == 8] %>% 
  melt(measure.vars = paste0("pred", c(5))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  facet_wrap(~variable) +
  labs(x = "", y = "", color = "",
       subtitle = "TLR^2") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  diag_rad[sensor == "amsua_n19" & date == as_datetime("2018-11-17 08:00:00") & channel == 8] %>% 
  melt(measure.vars = paste0("pred", c(8))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  # facet_wrap(~variable) +
  labs(x = "", y = "", color = "",
       subtitle = "Emisividad") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### MHS

La corrección del bias para el sensor MHS en cada periodo es menos clara que para AMSU-A (Figura \@ref(fig:bias-mhs)). Los cambios en pre-RAD2 son muy pequeños y en algunos casos se observan valores muy grandes y mayores a pre-RAD1. Por ejemplo el canal 1 que tiene el máximo cerca de superficie es el que muestra mayor dispersión, esto disminuye mucho para el sensor sobre METOP-A y B (aunque en este ultimo caso la mediana se aleja de cero) pero para NOAA19 la dispersión no cambia particularmente (pero la mediana está más cerca de cero). Esto podría estar indicando que la corrección de bias con los coeficientes entrenados es mayor.




```{r bias-mhs, fig.cap="Bias de las radianzas de MHS en las distintas plataformas y para los dos periodos."}

files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA", 
                    pattern = "asim.", recursive = TRUE, 
                    full.names = TRUE)
files <- files[str_detect(files, pattern = "mhs")]

diag_rad <- purrr::map(files, function(f) {
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/{date_ana}/diagfiles/{file}" )
  read_diag_rad(f, exp = meta[[1]][["exp"]]) %>%
    .[]
  
}) %>%
  rbindlist()

diag_rad[qc == 0] %>% 
  ggplot(aes(factor(channel), tbc - tbcnob)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_boxplot(aes(color = exp)) +
  scale_color_manual(values = c("darkorange", cyan), labels = c("pre-RAD1", "pre-RAD2")) +
  labs(x = "Canal", y = "BIAS Corregido (K)",
       color = "") +
  facet_wrap(~sensor) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

De la misma manera la evolución temporal del bias para este sensor es muy variable y el periodo pre-RAD2 no muestran cambios marcados (Figura \@ref(fig:bias-temmp-mhs). Los valores de bias corregido aumentan y disminuyen alternativamente [TODO: podría deberse a la cantidad de observaciones? eso parece cumplirse en el canal 4 pero se ve lo contrario en el canal 2].

```{r bias-temmp-mhs, fig.cap="Bias medio de las radianzas de MHS para los dos periodos a lo largo del tiempo.El tamaño de los puntos indican la cantidad de observaciones en cada ciclo.", fig.height=4}

diag_rad[qc == 0] %>% 
  .[, .(mean_bias = mean(tbc - tbcnob, na.rm = TRUE),
        mean_mag_bias = mean(abs(tbc - tbcnob), na.rm = TRUE),
        n = .N), by = .(date, sensor, exp, channel)] %>% 
  ggplot(aes(date, mean_bias)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_line(aes(color = exp, group = interaction(exp, channel))) +
  geom_point(aes(color = exp, size = n)) +
  scale_color_manual(values = c("darkorange", cyan), labels = c("pre-RAD1", "pre-RAD2")) +
  scale_size_area(max_size = 4) +
  labs(x = "Canal", y = "BIAS corregido (K)",
       color = "", size = "") +
  facet_wrap(~channel, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

En cuanto a la contribución para la corrección del bias por parte de los distintos predictores en MHS (Figura \@ref(fig:bias-pred-mhs)) se ven mayores diferencias entre los dos periodos. El canal 1 tiene un pico de 5 K al comienzo del periodo y los canales 4 y 5  tienen algunos valores cercanos a 3 K sobre todo en el periodo pre-RAD2. Para el resto de los canales los valores son similares a lo observado para AMSU-A (Figura \@ref(fig:bias-pred-amsua)). El predictor que más contribuye al bias total es distintos para cada canal, por ejemplo en el canal 3 el más importante es el Offset mientras que para el canal 4 es el TLR^2.

```{r bias-pred-mhs, fig.cap="Evolución temporal del bias asociado a cada predictor para los sensores MSH en las distintas plataformas", fig.height=5}

diag_rad[qc == 0] %>% 
  .[, bias_total := pred1 + pred2 + pred3 + pred4 + pred5 + pred6 + pred7 + pred8] %>% 
  melt(measure.vars = c("pred1", "pred2", "pred3", "pred4", 
                        "pred5", "pred6", "pred7", "pred8", "bias_total")) %>% 
  .[, .(mean_bias = mean(value, na.rm = TRUE)), by = .(variable, date, exp, channel, sensor)] %>% 
  .[!(sensor %in% c("amsua_aqua", "amsua_metop-a")) & 
      channel %in% c(1:5) & variable %in% c("pred1", "pred3", "pred4", "pred5", "pred8", "bias_total")] %>% 
  ggplot(aes(date, mean_bias)) +
  geom_line(aes(color = variable, linetype = exp)) +
  scale_color_brewer(type = "qual", palette = "Dark2",
                     labels = c("pred1" = "Offset",
                                "pred3" = "CLW",
                                "pred4" = "TLR^2",
                                "pred5" = "TLR",
                                "pred8" = "Emiss")) +
  scale_linetype_discrete(name = "", labels = c("pre-RAD1", "pre-RAD2")) +
  facet_grid(channel~sensor, scales = "free") +
  labs(color = "", linetype = "",
       x = "", y = "BIAS predicho") +
  theme_minimal() +
  theme(legend.position = "bottom")


```

Para estos sensores en particular llama la atención las diferencias entre los dos periodos, por ejemplo en el canal 4 de METOP-B hay un cambio de magnitud del bias que ocurre alrededor de 16 de noviembre y que se mantiene luego en pre-RAD2 en forma de picos. Para explorar la posibilidad de que este cambio se deba realmente al entrenamiento de los coeficiente y que a partir de esos momentos la corrección del bias esté mejorando, en la Figura \@ref(fig:mhs-bias-res) se muestra la media de la innovación con bias corregido (línea llena) y bias sin corregir (línea punteada). Se espera que la distribución de la innovación sea aproximadamente gausiana y por lo tanto que la media esté cerca de cero. Una desvíación de cero podría indicar que queda un bias *residual* luego de la corrección.

En la figura se ven las diferencias bastante marcadas entre la media de la innovación con y sin bias corregido y que en la mayoría de los casos el primer es más cercano a cero, indicando que la corrección del bias va en la dirección correcta. En particular para el canal 4 de METOP-B se obsera que la media de la innovación corregida luego de 16 de noviembre se aleja de cero y esto se mantiene también durante el periodo pre-RAD2. Si bien no es posible identificar ninguna causa esto podía indicar que el coeficiente asociado al TLR^2 cambió afectando negativamente a la corrección del bias y esto se mantuvo a lo largo del tiempo.


```{r mhs-bias-res, fig.cap="Valor medio de la diferencia entre las observaciones y el pronóstico (O - B) a lo largo del tiempo para cada periodo, sensor y canal"}
diag_rad %>% 
  .[qc == 0] %>% 
  melt(measure.vars = c("tbc", "tbcnob")) %>% 
  .[, .(ob_mean = mean(value, na.rm = TRUE),
       ob_sd = sd(value, na.rm = TRUE)), by = .(date, sensor, channel, exp, variable)] %>% 
  # melt(measure.vars = c("ob_mean", "ob_sd"),  variable.name = "estadistico", 
  #      value.name = "valor") %>% 
ggplot(aes(date, ob_mean)) +
  geom_hline(yintercept = 0) +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp, linetype = variable)) +
  scale_color_manual(values = c("darkorange", cyan), labels = c("pre-RAD1", "pre-RAD2")) +
  scale_linetype_discrete(labels = c("Bias corregido", "Sin corrección")) +
  facet_grid(channel~sensor, scales = "free_y") +
  labs(y = NULL, x = NULL, color = NULL, linetype = NULL) +
  theme_minimal()

```

La distribución espacial de la corrección del bias asociado a los predictores de TLR^2 y emisividad para un tiempo en particular se muestran en la Figura \@ref(fig:pred-mhs). En este tiempo la pasada del satélite cubrió gran parte del dominio. Respecto de la corrección asociada a la emisividad se observan valores distintos de cero en algunas regiones muy localizadas (sucede parecido en otros tiempos) en las zonas de mayor topografía. Esto podría deberse a que el nivel de presión asociado a esas observaciones se encuentra más cerca de la superficie? El TLR^2 tiene valores pequeños y varian de signo según la región. 

```{r pred-mhs, fig.cap="Contribución a la corrección del bias de dos predictores para el canal 3 de MHS NOAA19 a las 8 UTC del 17/11/2018. Incluye todas las observaciones de la pasada, aún si no pasan el control de calidad."}
diag_rad[sensor == "mhs_n19" & date == as_datetime("2018-11-17 08:00:00") & channel == 3] %>% 
  melt(measure.vars = paste0("pred", c(5))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  # facet_wrap(~variable) +
  labs(x = "", y = "", color = "",
       subtitle = "TLR^2") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  diag_rad[sensor == "mhs_n19" & date == as_datetime("2018-11-17 08:00:00") & channel == 3] %>% 
  melt(measure.vars = paste0("pred", c(8))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  # facet_wrap(~variable) +
  labs(x = "", y = "", color = "",
       subtitle = "Emisividad") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### Algunos casos de estudio

A continuación se analizan algunos casos de estudio desde el punto de vista de la precipitación acumulada en una hora comparando el análisis con la precipitación estimada por IMERG.


#### 2018-11-13 01:00Z

El primer caso corresponder a las 01 UTC del 13 de noviembre y corresponde al 8vo ciclo de asimilación. 

```{r}
files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA", 
                    pattern = "NPP_2018-11-13_01", recursive = TRUE, 
                    full.names = TRUE)

pp <- purrr::map(files, function(f) {
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/NPP/NPP_{date}_AN.nc")
  ReadNetCDF(f, vars = c("precipitacion" = "PP", 
                         "XLAT", 
                         "XLONG")) %>% 
    .[, c("x", "y") := wrf_project(XLONG, XLAT, inverse = FALSE)] %>% 
    .[, exp := meta[[1]][[1]]] %>% 
    .[]
}) %>%
  rbindlist()

imerg_path <- "/home/paula.maldonado/datosalertar1/RRA_VERIF/data/raw/imerg_raw"

files <- list.files(imerg_path, pattern = "20181113-S00", full.names = TRUE)

pp_imerg <- purrr::map(files, function(f) {
  meta <- unglue(basename(f), "3B-HHR-L.MS.MRG.3IMERG.{dia}-S{hora_ini}-E{hora_fin}.{algo}.V05B.RT-H5")
  ReadNetCDF(f, 
             vars = c(pp = "Grid/precipitationCal"), 
             subset = list("Grid/lon" = -80:-50, 
                           "Grid/lat" = -45:-15)) %>% 
    .[, fecha := ymd_hms(paste0(meta[[1]][[1]], meta[[1]][[2]]))]
  
}) %>% 
  rbindlist() %>% 
  setnames(c("Grid/lon", "Grid/lat"), c("lon", "lat")) %>% 
  .[, .(pp_acum = sum(pp)), by = .(lon, lat)]

```

En la Figura \@ref(fig:caso1) se muestra arriba la precipitación acumulada para la media del ensamble según cada experimento, abajo a la izquierda la diferencia entre los dos campos y a la derecha la precipitación acumulada según IMERG. En primer lugar es importante notar que los acumulados son mucho menores en los experimentos pero al mismo tiempo hay que tener en cuenta que en la media de los ensables se pierden las características de los miembros con distintas parametrizaciones. En particular algunas parametrizaciones muestran sistemáticamente menor convección afectando la precipitación acumulada. 

Las diferencias entre los dos periodos se observan principalmente en toda la franja de precipitación con una disminución en el experimento pre-RAD2 sobre todo en Entre Rios, sur de Uruguay y Rio de la Plata, donde ambos experimentos subestiman la precipitación pero la sobreestiman sobre Santiago del Estero donde no se registró lluvia. Esta sobreestimación disminuye en pre-RAD2 y al mismo tiempo corrige la precipitación sobre Córdoba. Sobre Jujuy y Salta pre-RAD2 muestra mayor precipitación pero ubicada al oeste de las observaciones. 

```{r caso1, fig.cap="Precipitación acumulada en 60 minutos para cada experimento (arriba), diferencia entre los experimentos (abajo, izquierda) y precipitación acumulada según IMERG (abajo, derecha)", fig.height=7}
p1 <- pp[, .(precipitacion = mean(precipitacion, na.rm = TRUE)), by = .(x, y, exp)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = precipitacion), proj = norargentina_lambert,
                    breaks = seq(0, 25, 2.5)) +
  
  scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 25, 2.5),
                       limits = c(2.5, NA),
                       na.value = "white",
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  theme_minimal() +
  theme(legend.position = "bottom") 

p2 <- pp[, .(precipitacion = mean(precipitacion, na.rm = TRUE)), by = .(x, y, exp)] %>% 
  dcast(x + y ~ exp, value.var = "precipitacion") %>% 
  .[, diff := week2 - week1] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = diff), proj = norargentina_lambert, 
                    breaks = AnchorBreaks(anchor = 0, binwidth = 2, 
                                          exclude = 0)) +
  scale_fill_divergent(breaks = AnchorBreaks(anchor = 0, binwidth = 2, 
                                             exclude = 0), 
                       guide = guide_colorstrip(barwidth = 10,
                                                barheight = 1)) +
  # scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 25, 2.5)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  theme_minimal() +
  theme(legend.position = "bottom") 


p3 <- pp_imerg %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = pp_acum), #proj = norargentina_lambert,
                    breaks = seq(0, 45, 5)) +
  
  scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 45, 5),
                       limits = c(5, NA),
                       na.value = "white",
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  theme_minimal() +
  theme(legend.position = "bottom") 

(p1 / (p2 + p3)) + plot_layout(widths = 1) 
# plot_layout(ncol = 2, widths = c(3, 1), heights = c(1, 1))

```

En cuanto a la probabilidad de precipitación acumulada mayor a 5 mm (Figura \@ref(fig:caso1-prob)) las diferencias son importantes en la zona del sur de Santa Fe, Entre Rios y Buenos Aires principalmente. En pre-RAD1 la precipitación acumulda parece mucho más extendida en el dominio pero con mayor dispersión entre los miembros del ensable. En pre-RAD2 aparecen valores de probabilidad 
de entre 30 y 50% sobre la provincia de Córodba y sobre Salta en la región donde se observa precipitación acumulada. Al mismo tiempo sobre Buenos Aires se observa una probabilidad de entre 10 y 20% al sur y mayor al 30% al este que no se observan en la realidad. 

```{r caso1-prob, fig.cap="Probabilidad de precipitación acumulada > 5 mm (arriba) y > 25 mm (abajo) para cada experimento en el caso 1.", fig.height=7}
pp[, .(prop = mean(precipitacion > 5)*100), by = .(exp, x, y)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = prop), proj = norargentina_lambert,
                    breaks = seq(0, 100, 10)) +
  scale_fill_gradientn(colours = rev(Redmonder::redmonder.pal(10, name = "qMSOStd")), 
                       limits = c(10, 100),
                       na.value = "white",
                       breaks = seq(0, 100, 10),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  ggtitle("Probabilidad de precipitación acumulada > 5 mm") +
  theme_minimal() +
  theme(legend.position = "bottom") 
  
  # pp[, .(prop = mean(precipitacion > 25)*100), by = .(exp, x, y)] %>% 
  # ggplot(aes(x, y)) +
  # geom_contour_fill(aes(z = prop), proj = norargentina_lambert,
  #                   breaks = seq(0, 100, 10)) +
  # scale_fill_gradientn(colours = rev(Redmonder::redmonder.pal(10, name = "qMSOStd")), 
  #                      limits = c(10, 100),
  #                      na.value = "white",
  #                      breaks = seq(0, 100, 10),
  #                      guide = guide_colorstrip(barwidth = 15,
  #                                               barheight = 1)) +
  # geom_mapa() +
  # labs(fill = "", x = "", y = "") +
  # facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  # ggtitle("Probabilidad de precipitación acumulada > 25 mm") +
  # theme_minimal() +
  # theme(legend.position = "bottom") +
  # plot_layout(ncol = 1, guides = "collect", widths = 0.5, heights = 2) &
  # theme(legend.position = "bottom") 
```


#### 2018-11-18 10:00Z

El segundo caso de estudio corresponde a las 10 UTC del 18 de noviembre casi 7 días luego del comienzo de cada periodo de asimilación continua. En este caso la precipitación se da sobre el norte de argentina y sur de Paraguay y Brasil, con algo de precipitación sobre Salta. 

```{r}
files <- list.files("/home/paola.corrales/datosmunin/EXP/E7-training/ANA", 
                    pattern = "NPP_2018-11-18_10", recursive = TRUE, 
                    full.names = TRUE)

pp <- purrr::map(files, function(f) {
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/E7-training/ANA/{exp}/NPP/NPP_{date}_AN.nc")
  ReadNetCDF(f, vars = c("precipitacion" = "PP", 
                         "XLAT", 
                         "XLONG")) %>%
    .[, c("x", "y") := wrf_project(XLONG, XLAT, inverse = FALSE)] %>% 
    .[, exp := meta[[1]][[1]]] %>% 
    .[]
}) %>%
  rbindlist()

imerg_path <- "/home/paula.maldonado/datosalertar1/RRA_VERIF/data/raw/imerg_raw"

files <- list.files(imerg_path, pattern = "20181118-S09", full.names = TRUE)

pp_imerg <- purrr::map(files, function(f) {
  meta <- unglue(basename(f), "3B-HHR-L.MS.MRG.3IMERG.{dia}-S{hora_ini}-E{hora_fin}.{algo}.V05B.RT-H5")
  ReadNetCDF(f, 
             vars = c(pp = "Grid/precipitationCal"), 
             subset = list("Grid/lon" = -80:-50, 
                           "Grid/lat" = -45:-15)) %>% 
    .[, fecha := ymd_hms(paste0(meta[[1]][[1]], meta[[1]][[2]]))]
  
}) %>% 
  rbindlist() %>% 
  setnames(c("Grid/lon", "Grid/lat"), c("lon", "lat")) %>% 
  .[, .(pp_acum = sum(pp)), by = .(lon, lat)]

```


En el campo de diferencia en la Figura \@ref(fig:caso2) se observa que en pre-RAD2 disminuye la precipitación acumulada sobre Salta, Jujuy y Tucumán (esta última no se observa en IMERG) mientras que aumenta sobre Formosa y Chaco donde se dan los mayores acumulados de precipitación. De nuevo, los paneles superiores muestran la media del ensable por lo que muchas características de la ubicación de la precipitación acumulada se pierden y hay mucha variabilidad entre los miembros.

```{r caso2, fig.cap="Precipitación acumulada en 10 minutos para cada experimento (arriba), diferencia entre los experimentos (abajo, izquierda) y precipitación acumulada en 30 minutos según IMERG (abajo, derecha)", fig.height=7}
p1 <- pp[, .(precipitacion = mean(precipitacion, na.rm = TRUE)), by = .(x, y, exp)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = precipitacion), proj = norargentina_lambert,
                    breaks = seq(0, 25, 2.5)) +
  
  scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 25, 2.5),
                       limits = c(2.5, NA),
                       na.value = "white",
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  theme_minimal() +
  theme(legend.position = "bottom") 

p2 <- pp[, .(precipitacion = mean(precipitacion, na.rm = TRUE)), by = .(x, y, exp)] %>% 
  dcast(x + y ~ exp, value.var = "precipitacion") %>% 
  .[, diff := week2 - week1] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = diff), proj = norargentina_lambert, 
                    breaks = AnchorBreaks(anchor = 0, binwidth = 1, 
                                          exclude = 0)) +
  scale_fill_divergent(breaks = AnchorBreaks(anchor = 0, binwidth = 1, 
                                             exclude = 0), 
                       guide = guide_colorstrip(barwidth = 10,
                                                barheight = 1)) +
  # scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 25, 2.5)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  theme_minimal() +
  theme(legend.position = "bottom") 


p3 <- pp_imerg %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = pp_acum), #proj = norargentina_lambert,
                    breaks = seq(0, 40, 5)) +
  
  scale_fill_distiller(palette = "YlGnBu", direction = 1, breaks = seq(0, 40, 5),
                       limits = c(5, NA),
                       na.value = "white",
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  theme_minimal() +
  theme(legend.position = "bottom") 

(p1 / (p2 + p3)) + plot_layout(widths = 1) 

```

Esto puede verse en la Figura \@ref(fig:caso2-prob) que muestra la probabilidad de precipitación acumulada mayor a 5 mm. En pre-RAD2 se ve mayor probabilidad de precipitación por encima de 50% extendida sobre gran parte de la provincia de Formosa mientras que la precipitación observada según IMERG se localiza más hacia el este. La precipitación que se observa sobre Misiones en los experimentos no debe ser considerada con mucha confianza ya que se encuentran en el borde del diminio de simulación. 


```{r caso2-prob, fig.cap="Probabilidad de precipitación acumulada > 5 mm (arriba) y > 25 mm (abajo) para cada experimento correspondiente al caso 2", fig.height=7}
pp[, .(prop = mean(precipitacion > 5)*100), by = .(exp, x, y)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = prop), proj = norargentina_lambert,
                    breaks = seq(0, 100, 10)) +
  scale_fill_gradientn(colours = rev(Redmonder::redmonder.pal(10, name = "qMSOStd")), 
                       limits = c(10, 100),
                       na.value = "white",
                       breaks = seq(0, 100, 10),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 1)) +
  geom_mapa() +
  labs(fill = "", x = "", y = "") +
  facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  ggtitle("Probabilidad de precipitación acumulada > 5 mm") +
  theme_minimal() +
  theme(legend.position = "bottom") 
  
  # pp[, .(prop = mean(precipitacion > 25)*100), by = .(exp, x, y)] %>% 
  # ggplot(aes(x, y)) +
  # geom_contour_fill(aes(z = prop), proj = norargentina_lambert,
  #                   breaks = seq(0, 100, 10)) +
  # scale_fill_gradientn(colours = rev(Redmonder::redmonder.pal(10, name = "qMSOStd")), 
  #                      limits = c(10, 100),
  #                      na.value = "white",
  #                      breaks = seq(0, 100, 10),
  #                      guide = guide_colorstrip(barwidth = 15,
  #                                               barheight = 1)) +
  # geom_mapa() +
  # labs(fill = "", x = "", y = "") +
  # facet_wrap(~exp, labeller = labeller(exp = c("week1" = "pre-RAD1", "week2" = "pre-RAD2"))) +
  # ggtitle("Probabilidad de precipitación acumulada > 25 mm") +
  # theme_minimal() +
  # theme(legend.position = "bottom") +
  # plot_layout(ncol = 1, guides = "collect", widths = 0.5, heights = 2) &
  # theme(legend.position = "bottom") 
```

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

<script src="https://hypothes.is/embed.js" async></script>
