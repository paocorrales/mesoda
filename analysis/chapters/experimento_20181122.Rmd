---
title: "Asimilación de distintas observaciones"
output: 
  bookdown::html_document2: default
  bookdown::pdf_document2: default
bibliography: mesoda_ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "../figures/",
  fig.retina = TRUE,
  # fig.height = 3,
  dev = "png",
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)
library(mesoda)
library(metR)
library(tidyverse)
library(lubridate)
library(data.table)
library(here)
library(patchwork)
library(unglue)
library(knitr)
library(kableExtra)

map_arg <- rnaturalearth::ne_states(country = c("argentina"), 
                                      returnclass = "sf")
map_limitrofes <- rnaturalearth::ne_countries(country = c("Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

square <- fread(here("analysis", "data", "derived_data", "dominio_square.csv"))
square2 <- fread(here("analysis", "data", "derived_data", "dominio_square2.csv"))
coord <- fread(here("analysis", "data", "derived_data", "coordenadas.csv"))


geom_mapa <- function(fill = NA) {
  list(geom_sf(data = map_arg, fill = fill, color = "black", size = 0.1, inherit.aes = FALSE),
       geom_sf(data = map_limitrofes, fill = fill, color = "black", size = 0.1, inherit.aes = FALSE),
       coord_sf(ylim = c(-42, -19), xlim = c(-76, -51)),
       scale_x_longitude(ticks = 5),
       scale_y_latitude(ticks = 5))
}

arg_topo <- metR::GetTopography(-75+360, -50+360, -20, -60, resolution = 1/10)
arg_topo[, lon := metR::ConvertLongitude(lon)]

cordillera <- list(
  ggnewscale::new_scale_fill(),
  geom_contour_fill(data = arg_topo, aes(x = lon, y = lat, 
                                         z = h),
                    breaks = seq(1500, 8000, by = 700)),
  scale_fill_gradient(low = "#E2E6E6", high = "#7E7E7E", guide = "none",
                      oob = scales::squish))

scale_date <- function(ini = 20181120180000, end = 20181123120000,
                       break_bin = "6 hour") {
  scale_x_datetime(breaks = seq.POSIXt(ymd_hms(ini), ymd_hms(end), by = break_bin),
                   labels = function(x) {
                     fifelse(hour(x) == 0, format(x, "%H\n%b %d"), format(x, "%H"))
                   }) 
}

obs.type <- tribble(
  ~type, ~code,
  120, "ADPUPA",
  130, "AIRCFT-AIREP",
  131, "AIRCFT-AMDAR",
  133, "AIRCAR",
  180, "SFCSHP",
  181, "ADPSFC",
  187, "ADPSFC\nno pressure",
  220, "ADPUPA",
  221, "ADPUPA-PIBAL",
  230, "AIRCFT-AIREP",
  231, "AIRCFT-AMDAR",
  233, "AIRCAR",
  280, "SFCSHP",
  281, "ADPSFC",
  287, "ADPSFC\nno pressure",
  290, "ASCATW"
) %>% 
  setDT()

fisica <- data.table(mem = as.character(formatC(1:60, flag = "0", width = 3)),
                     fisica = rep(c("KF-YSU", 
                                    "BMJ-YSU",
                                    "GF-YSU",
                                    "KF-MYJ",
                                    "BMJ-MYJ",
                                    "GF-MYJ",
                                    "KF-MYNN2",
                                    "BMJ-MYNN2",
                                    "GF-MYNN2"), length.out = 60)) %>% setDT()

multiespectrales <- c("airs_aqua",
              "iasi_metop-a",
              "iasi_metop-b")

experiments <- c("E4", "E5", "E6", "E7")
#Color blind friendly but E4 y E7 parecidos en Desaturated
colores_exp <- c(E4 = "#0077BB", E5 = "#88CCEE", E6 = "#EE7733", E7 = "#CC3311") 
# colores_exp <- c(E4 = "#225555", E5 = "#CCBB44", E6 = "#CC6677", E7 = "#882255")
satinfo <- fread(here("analysis", "data", "derived_data", "satinfo.txt")) %>% 
  setnames(c("!sensor/instr/sat", "chan"), c("sensor", "channel"))
derived_data <- "/home/paola.corrales/datosmunin/EXP/derived_data/"

```

## Case Study: November 22th, 2020

The experiments focus on a mesoscale convective system developed over central and north-eastern Argentina during November 22th, 2018. This MCS corresponds to IOP08 (Severe, Upscale Growth handoff) of the RELAMPAGO field campaign.

This case stady was selected to focus on the RELAMPAGO period and to take advantage of the observations taken during the intensive observation periods. 


```{r caso-gif, fig.cap="GOES-16 channel 13 (clean longwave-IR) during November, 22th.", out.height=450, out.width=600, fig.align="center"}
knitr::include_graphics("https://github.com/paocorrales/Analisis_2018112022/blob/master/fig/caso_20181122.gif?raw=true")
```


### Model and ensemble configuration

To run the simulations the WRF-ARW (V3.9) model with 10 km horizontal resolution and xx vertical levels was used. The GFS deterministic run (0.5° resolution) was used for the initial and boundary conditions. 

The LETKF versión of the GSI system was choosen for the assimilation. A 60 member ensemble is initialized using random perturbations and a multi-physics squeme using 9 combinations of 3 Cumulus (Kain–Fritsch, Grell–Freitas, Betts–Miller–Janjic) and 3 PBL (Yonsei University Scheme, Mellor–Yamada–Janjic Scheme, Mellor–Yamada Nakanishi Niino) parameterizations as shown in Table \@ref(tab:fisicas).

```{r fisicas}
fisica[, .(mem = paste(mem, collapse = ", ")), by = .(fisica)] %>% 
  kbl(col.names = c("Parameterizations", "# Member"),
      caption = "Posible Cumulus and PBL combinations and the members in each group.") %>% 
  kable_classic_2(full_width = F)
```


The domain shown in Figure \@ref(fig:dominio) covers the center and north of Argentina and part of Bolivia and Paraguay to capture the development of the MCS during the simulation period (up to 12UTC 2020/11/23).



```{r dominio, fig.cap="Horizontal domain for all simulations and topography.", fig.height=4}
fread(here("analysis", "data", "derived_data", "dominio_hgt.csv")) %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  scale_fill_distiller(name = NULL,
                       type = "seq",
                       palette = "RdYlGn",
                       direction = -1,
                       breaks = seq(0, 6000, 1000),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.8)) +
  geom_mapa() +
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  geom_point(data = square2, aes(lon, lat), size = 0.2, color = "darkgrey") +
  theme_minimal() +
  theme(legend.position = "bottom", legend.box.spacing = margin(0, 0, 0, 0)) 
```

### Experiments configuration

#### Assimilation cycle

Each simulation starts at 12 UTC on Nov 20th with 6 hours of spin up. The assimilation starts at 18 UTC and continue until 12 UTC Nov, 23th every houer. Two ensemble forecasts are initialized from de the analysis at 00 and 06 UTC Nov 22th and continue until 12 UTC Nov 23rd (Figure \@ref(fig:ciclo)). 

The analysis is perform in one-hour cetered window using the Observation Operator from GSI to compare the available observations with the first guess at the closest time (FGAT - First Guess at Appropriate Time). Then the LETKF is run to apply the innovations to the analysis for each member. 

```{r ciclo, fig.cap="Diagram of analysis cycles between Nov 20th, 18 UTC and Nov 23rd 12 UTC plus and spin up period of 6 hours. The zoomed figure shows assimilation in one-hour centered window and new boundary conditions from GFSD every 6 hours.", out.height=400, out.width=800, fig.align="center"}
knitr::include_graphics(here("analysis", "figures", "analysis_cycle.svg"))
```
Four experiments were performed using an incremental set of observations each time (Table \@ref(tab:obs)). The CONV experiment uses conventional observations from the prepBUFR file that includes surface observations (land and sea) and profiles from soundings and aircrafts. On the Figure \@ref(fig:mapa-obs), the orange dots are the surface stations and ships locations included in this experiment. 

The AUT experiment add to CONV the regional automatic stations networks from Argentina and near countries. The added stations are colored in green in Figure \@ref(fig:mapa-obs). This stations have greater spatial coverage and higher sampling frequency.

SATWND add to AUT the satellite motion vectors from several satellites including GOES-16 and finally the RAD experiments also includes randiances observations from sensors over polar orbit satellites.

```{r obs}
tribble(
  ~obs_type, ~conv, ~aut, ~satwnd, ~rad,
  "ADPSFC", "x", "x", "x", "x",
  "ADPUPA", "x", "x", "x", "x",
  "AIRCFT", "x", "x", "x", "x",
  "AIRCAR", "x", "x", "x", "x",
  "SFCSHP", "x", "x", "x", "x",
  "ASCATW", "x", "x", "x", "x", 
  "AUTSFC", " ", "x", "x", "x",
  "SATWND", " ", " ", "x", "x",
  "RAD", " ", " ", " ", "x",
) %>% 
  kbl(col.names = c("Obs type", "CONV", "AUT", "SATWND", "RAD"),
      caption = "Observation types assimilated in each experiment.") %>% 
  kable_classic_2(full_width = F)
```

```{r mapa-obs, fig.cap="Localization of meteorological stations and ships for official prep-BUFR (orange dots) and automatic statios (green dots).", fig.height=4, fig.width=8}
obsAUT <- fread(here("analysis", "data", "raw_data", "E5_asim_conv_20181121120000.ensmean"), 
                na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
  .[, c("V2", "V4") := NULL] %>% 
  setnames(colnames(.), c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr"))


obsCONV <- fread(here("analysis", "data", "raw_data", "E4_asim_conv_20181121120000.ensmean"), 
                 na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
  .[, c("V2", "V4") := NULL] %>% 
  setnames(colnames(.), c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr"))


obsSATW <- fread(here("analysis", "data", "raw_data", "E6_asim_conv_20181121120000.ensmean"), 
                 na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
  .[, c("V2", "V4") := NULL] %>% 
  setnames(colnames(.), c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr"))


oficiales <- obsCONV[type %in% c(181, 281)] %>% unique(by = c("stationID")) %>% 
  .[, source := "Sfc - Official"]

sondeos <- obsCONV[type == 120] %>% unique(by = c("stationID")) %>% 
  .[, source := "ADPUPA"]

ascat <- obsCONV[type == 290] %>% unique(by = c("stationID")) %>% 
  .[, source := "ASCATW"]

aircraf <- obsCONV[type %in% c(130, 131, 133)] %>%# unique(by = c("stationID")) %>% 
  .[, source := "AIRCFT /\nAIRCAR"]

satwnd <- obsSATW[type %between% c(240, 260)] %>%# unique(by = c("stationID")) %>% 
  .[, source := "SATWND"]

no_oficiales <- obsAUT %>% 
  .[type %in% c(181, 187)] %>% 
  .[!str_detect(stationID, "SMN")] %>%
  .[!stationID %in% oficiales$stationID] %>% 
  unique(by = c("stationID")) %>% 
  .[, source := "Sfc - Non-official"]



rbindlist(list(no_oficiales, oficiales)) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_mapa() +
  geom_point(alpha = 0.8, size = 1,
             aes(color = source, shape = source)) +
  scale_shape_manual(name = "Surface\nstations",  breaks = c("Sfc - Non-official", "Sfc - Official"),
                     labels = c("ASWS","CSWS"), values = c(15, 17),
                     guide = guide_legend(override.aes = list(size = 2))) +
  scale_color_manual(name =  "Surface\nstations", values = c("Sfc - Non-official" = "#00695c", 
                                              "Sfc - Official" = "#FD8002"),
                     breaks = c("Sfc - Non-official", "Sfc - Official"),
                     labels = c("ASWS","CSWS"),
                     guide = guide_legend(override.aes = list(size = 2)))+
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.justification = "left",
         legend.key.size = unit(0.8, "lines")) +
  
  # plot_spacer() +
  
  rbindlist(list(ascat, sondeos, aircraf, satwnd)) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_mapa() +
  geom_point(alpha = 1,
             aes(color = source, shape = source, size = source)) +
  scale_color_manual(values = c("darkorange", "purple", "cyan4", "grey70"),
                     guide = guide_legend(override.aes = list(size = 2))) +
  scale_size_manual(values = c(1.5, 0.7, 0.5, 0.1)) +
  # scale_color_brewer(palette = "Dark2") +
  # khroma::scale_color_vibrant() +
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  labs(color = NULL, shape = NULL, size = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom", legend.justification = "left",
        legend.key.size = unit(0.8, "lines")) +
  
  plot_layout(ncol = 3, widths = c(1, 1)) +
  plot_annotation(tag_levels = "a", tag_suffix = ")")
```

Figure with all type of observations (radiosonde, convencional, automatic station, aircraft, ships/buoys, satwind)
Figure with number of observation throughout the cycles for each type including riadiances.



```{r rad, fig.cap="Radiances for each 50 hPa pressure layer over time", fig.scap=c("OmB", "Number of observations")}

files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E7/ANA/*/diagfiles/asim*ensmean")

files <- files[!str_detect(files, "conv")]


rad <- read_diag_rad(files, "E7") %>% 
  satinfo[., on = c("sensor", "channel")]

rad %>% 
  .[qc == 0 & iuse == 1] %>% 
  .[, lev := factor(cut_round(peakwt, breaks = seq(0, 1050, 50)))] %>% 
  .[, .(omb = mean(tbc),
        n = .N), by = .(date, lev)] %>% 
  .[lev != 1025] %>% 
  ggplot(aes(date, fct_rev(lev))) +
  geom_tile(aes(fill = omb)) +
  scale_fill_divergent(trans = mesoda::symlog_trans(),
                       guide = guide_colourbar(barheight = 18))  +
  # scale_y_level() +
  scale_date() +
  # scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H:%M") +
  labs(x = NULL, fill = NULL, y = "pressure (hPa)",
       caption = "OmB") +
  theme_minimal()

rad %>% 
  .[qc == 0 & iuse == 1] %>% 
  .[, lev := factor(cut_round(peakwt, breaks = seq(0, 1050, 50)))] %>% 
  .[, .(omb = mean(tbc),
        n = .N), by = .(date, lev)] %>% 
  .[lev != 1025] %>% 
  ggplot(aes(date, fct_rev(lev))) +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c(trans = scales::log10_trans(), breaks = c(1, 10, 100, 1000, 10000),
                       guide = guide_colourbar(barheight = 18,
                                               barwidth = 0.8)) +
  
  scale_date() +
  labs(x = NULL, fill = NULL, y = "pressure (hPa)") +
  theme_minimal()

```

```{r level-rad, fig.cap="Nivel de presión asociado a las observaciones en cada ciclo de asimilación"}
rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[sensor %in% c("airs", "iasi") &
      # errinv %between% c(0.0000316227, 1000) & 
      # qc == 0 & 
      # iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  .[, as.list(quantile(peakwt, c(0.05, 0.5, 0.95))) %>% setNames(c("Q5", "Q50", "Q95")), by = .(sensor, channel)] %>% 
  ggplot(aes(channel, Q50)) +
   # geom_boxplot(aes(group = factor(channel)), outlier.color = "darkorange", 
   #             outlier.size = 0.5, size = 0.1) +
  geom_ribbon(aes(ymin = Q5, ymax = Q95), alpha = 0.4, fill = "darkorange") +
  geom_line(color = "darkorange") +
  scale_y_level(name = "Pressure (hPa)") +
  facet_wrap(~sensor, scales = "free", labeller = labeller(sensor = toupper)) +
  labs(x = "", y = "") +
  theme_minimal() +
  
rad %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  .[!sensor %in% c("airs", "iasi") &
      # errinv %between% c(0.0000316227, 1000) & 
      # qc == 0 & 
      # iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  .[, as.list(quantile(peakwt, c(0.05, 0.5, 0.95))) %>% setNames(c("Q5", "Q50", "Q95")), by = .(sensor, channel)] %>% 
  ggplot(aes(channel, Q50)) +
   # geom_boxplot(aes(group = factor(channel)), outlier.color = "darkorange", 
   #             outlier.size = 0.5, size = 0.1) +
  geom_ribbon(aes(ymin = Q5, ymax = Q95), alpha = 0.4, fill = "darkorange") +
  geom_line(color = "darkorange") +
  scale_y_level(name = "Pressure (hPa)") +
  facet_wrap(~sensor, scales = "free", labeller = labeller(sensor = toupper)) +
  labs(y = "", x = "Channel index") +
  theme_minimal() +
  plot_layout(ncol = 1)
```


```{r rad-wv}
files <- c(Sys.glob("/home/paola.corrales/datosmunin/EXP/E7/ANA/20181121020000/diagfiles*/asim_iasi*ensmean"), Sys.glob("/home/paola.corrales/datosmunin/EXP/E7/ANA/20181121140000/diagfiles*/asim_iasi_metop-b*ensmean"))


rad <- purrr::map(files, function(f) {
  
  rad <- read_diag_rad(f, "E7") %>% 
    .[, run := basename(dirname(f))] %>% 
    .[, wavenumber := 1/(299792458/(freq*10000000))] %>% 
    .[wavenumber %between% c(1367, 1422.25)] %>% 
    satinfo[., on = c("sensor", "channel")]
}) %>% rbindlist()

rad %>% 
  .[sensor == "iasi_metop-b" & 
      channel == 335 & 
      errinv %between% c(0.0000316227, 1000) & 
      qc == 0 & 
      iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = tbc)) +
  scale_color_divergent(trans = mesoda::symlog_trans(),
                        guide = guide_colourbar(barheight = 15, barwidth = 1)) +
  geom_mapa() +
  facet_grid(run~date, labeller = labeller(run = c("diagfiles" = "OmB",
                                                   "diagfiles_ana" = "OmA"))) +
  labs(x = NULL, y = NULL, color = NULL) +
  theme_minimal() +
  
  
  rad %>% 
  .[sensor == "iasi_metop-b" & 
      channel == 335 & 
      errinv %between% c(0.0000316227, 1000) & 
      qc == 0 & 
      iuse == 1 &
      peakwt %between% c(0.001, 1200)] %>% 
  dcast(lon + lat + date ~ run, value.var = c("tbc")) %>% 
  .[, ":="(tbc = diagfiles - diagfiles_ana,
           run = "AmB")] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = tbc)) +
  scale_color_divergent(guide = guide_colourbar(barheight = 15, barwidth = 1)) +
  geom_mapa() +
  labs(x = NULL, y = NULL, color = NULL) +
  facet_grid(run~date) +
  theme_minimal() +
  plot_layout(ncol = 2, widths = c(0.4, 0.6))
```
```{r omb-qv-acum}

global_qv_E6 <- read_rds("~/mesoda/analysis/data/derived_data/omb_acum_qv_E6.rds")
global_qv_E7 <- read_rds("~/mesoda/analysis/data/derived_data/omb_acum_qv_E7.rds")

rbind(global_qv_E6, global_qv_E7) %>%
  # .[exp == "E7"] %>% 
  .[, nivel := fcase(bottom_top %in% c(1:8), "1 to 8",
                     bottom_top %in% c(9:13), "9 to 13",
                     bottom_top %in% c(14:20), "14 to 20",
                     bottom_top %in% c(21:38), "21 to 38")] %>%
  .[, acum := cumsum(qv), by = .(bottom_top, exp)] %>%
  # .[bottom_top %in% c(1:18)] %>%
  ggplot(aes(date, acum*1000)) +
  geom_line(aes(color = exp, linetype = exp, group = interaction(bottom_top, exp))) +
  # geom_label(data = ~.x[date %in% sample(unique(date), 38)] %>% group_by(exp, bottom_top) %>% sample_n(size = 1),
   geom_label(data = ~.x[date %in% unique(date)[67]],
             aes(label = bottom_top, color = exp, 
                 group = interaction(bottom_top, exp)),
             size = 3, fill = "white", show.legend = FALSE,
             label.size = NA, label.padding = unit(0.1, "lines")) +
  scale_date() +
  scale_linetype_manual(values = c(2, 1), labels = c(E4 = "CONV", E5 = "AUT",
                                     E6 = "SATWND", E7 = "RAD")) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  facet_wrap(~nivel, scales = "free_y") +
  labs(x = NULL, y = "Accumulated specific humidity (g/Kg)",
       color = NULL, linetype = NULL) +
  theme_minimal()
 

```


```{r}
files <- Sys.glob("~/datosmunin/EXP/E7/ANA/2018112*/diagfiles/asim*.ensmean")

files <- files[str_detect(files, "conv", negate = TRUE)]

rad <- read_diag_rad(files, "E7") %>% 
  satinfo[., on = c("sensor", "channel")] %>% 
  .[,  type :=  fifelse(sensor %in% multiespectrales, "multiespectral", "otro")] %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_")


rad[errinv %between% c(0.0000316227, 1000) & 
      qc == 0 & 
      iuse == 1 &
      peakwt %between% c(0.001, 1200), 
    .(tbc_mean = mean(tbc),
      tbcnob_mean = mean(tbcnob)), by = .(sensor, channel, date)] %>% 
  .[, diff := abs(tbcnob_mean) - abs(tbc_mean)] %>% 
  # .[, range(diff, na.rm = TRUE)]
  melt(id.vars = c("sensor", "channel", "date")) %>% 
  ggplot(aes(value)) +
  geom_histogram(aes(fill = variable, y = stat(density)), binwidth = 0.1,
                 alpha= 0.3, position = "identity") +
  geom_density(aes(color = variable, y = stat(density))) +
  # scale_fill_manual(values = c("darkorange", "purple", "cyan4")) +
  scale_fill_viridis_d(labels = c("OmB bc", "OmB nobc", "Difference")) +
  scale_color_viridis_d(labels = c("OmB bc", "OmB nobc", "Difference")) +
  geom_vline(xintercept = 0, color = "grey40") +
  coord_cartesian(xlim = c(-5, 5)) +
  facet_wrap(~sensor, labeller = labeller(sensor = toupper)) +
  labs(fill = NULL, x = NULL, color = NULL) +
  theme_minimal()

rad[errinv %between% c(0.0000316227, 1000) & 
      qc == 0 & 
      iuse == 1 &
      peakwt %between% c(0.001, 1200), 
    .(tbc_mean = mean(tbc),
      tbcnob_mean = mean(tbcnob)), by = .(sensor, channel, date)] %>% 
  .[, diff := abs(tbcnob_mean) - abs(tbc_mean)] %>% 
  # .[, range(diff, na.rm = TRUE)]
  melt(id.vars = c("sensor", "channel", "date")) %>% 
  ggplot(aes(value)) +
  geom_histogram(aes(fill = variable, y = stat(density)), binwidth = 0.1,
                 alpha= 0.3, position = "identity") +
  geom_density(aes(color = variable)) +
  # scale_fill_manual(values = c("darkorange", "purple", "cyan4")) +
  scale_color_viridis_d(labels = c("OmB BC", "OmB NoBC", "Difference")) +
  scale_fill_viridis_d(labels = c("OmB BC", "OmB NoBC", "Difference")) +
  geom_vline(xintercept = 0, color = "grey40") +
  coord_cartesian(xlim = c(-5, 5)) +
  # facet_wrap(~sensor) +
  labs(fill = NULL, x = NULL, color = NULL) +
  theme_minimal()


```

```{r}
rm(rad)
```


### Ensemble characteristics

#### Reduced Centered Random Variable

```{r rcrv-sfc, fig.cap="Standar deviation of rcrv calculate for surface observations included in boxes of 2.5 degree", fig.scap=c("Wind", "Temperature")}

fread(here("analysis", "data", "derived_data", "uvt_rcrv_box.csv")) %>%   
  .[var %in% c("u", "v") & type %in% c(280, 281, 287, 290)] %>% 
  .[, type.obs := type] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = sd.y)) +
  geom_mapa() +
  scale_fill_viridis_c(breaks = seq(0, 4, 0.5),
                       limits = c(0, 4),
                       direction = -1,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(var~type.obs, 
             labeller = labeller(type.obs = c("280" = "SFCSHP",
                                              "281" = "ADPSFC",
                                              "287" = "ADPSFC\n no pressure",
                                              "290" = "ASCATW"),
                                 var = c("u" = "U wind",
                                         "v" = "V wind" ))) +
  labs(fill = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

fread(here("analysis", "data", "derived_data", "uvt_rcrv_box.csv")) %>%
  .[var %in% c("t") & type %in% c(180, 181, 187)] %>% 
  .[, type.obs := type] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = sd.y)) +
  geom_mapa() +
  scale_fill_viridis_c(breaks = seq(0, 5, 0.5),
                       limits = c(0, 5),
                       direction = -1,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(var~type.obs, labeller = labeller(type.obs = c("180" = "SFCSHP",
                                                            "181" = "ADPSFC",
                                                            "187" = "ADPSFC\n no pressure"),
                                               var = c("t" = "Temperature"))) +
  labs(fill = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r rcrv-profile, fig.cap="Profiles of mean and standar deviation of rcrv for sounding and aircraft observations."}
obs.type[fread(here("analysis", "data", "derived_data", "rcrv_uvt_perfil.csv")), on = "type"] %>% 
  .[type != 130] %>%
  melt(measure.vars = c("mean.y", "sd.y")) %>% 
  ggplot(aes(nivel.error, value)) +
  geom_hline(yintercept = c(0, 1), color = "grey20") +
  geom_line(aes(color = factor(code), linetype = variable)) +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("Mean RCRV", "SD RCRV")) +
  scale_x_level(breaks = c(1000, 500, 250, 125, 50)) +
  coord_flip() +
  facet_wrap(~ var, labeller = labeller(var = c("t" = "Temperature",
                                                "u" = "U wind",
                                                "v" = "V wind"))) +
  labs(y = NULL,
       linetype = "",
       color = NULL) +
  theme_minimal() 
```

```{r rcrv-profile-rad, fig.cap="Profiles of mean and standar deviation of rcrv for radiances observations."}
files <- Sys.glob("/home/paola.corrales/mesoda/analysis/data/derived_data/rcrv_*_perfil.csv")[1:4]

RCRV <- purrr::map(files, function(f) {
  fread(f)
}) %>% 
  rbindlist()

RCRV %>% 
  separate(sensor, into = c("sensor", "plat"), sep = "_") %>% 
  setDT() %>% 
  melt(measure.vars = c("mean.y", "sd.y")) %>% 
  .[, .(value = mean(value, na.rm = TRUE)), by = .(sensor, level, variable)] %>% 
  ggplot(aes(level, value)) +
  geom_hline(yintercept = c(0, 1), color = "grey20") +
  geom_line(aes(color = sensor, linetype = variable)) +
  scale_color_discrete(labels = toupper) +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("Mean RCRV", "SD RCRV")) +
  coord_flip() +
  scale_x_level(breaks = c(1000, 500, 250, 125, 50)) +
  labs(x = NULL, y = NULL,
       color = NULL, linetype = NULL) +
  theme_minimal()

```


### Analysis comparison

To observe the impact of assimilating each source of observations on the vertical structure, the average vertical profiles for  the temperature, specific humidity and wind components were calculated over the grey box in Figure \@ref(fig:dominio).


```{r T-diff, fig.cap="Temperature difference between experiments in Kelvin."}
files <- list.files(derived_data, recursive = TRUE, full.names = TRUE,
                    pattern = "perfiles_ana")

perfiles <- purrr::map(files, function(f) {
  exp <- unglue(basename(f), "perfiles_{run}_{exp}.csv")
  fread(f) %>% 
    .[, exp := exp[[1]][["exp"]]]
  
}) %>% 
  rbindlist() %>% 
  .[, date := as_datetime(date)] %>% 
  .[date %between% c(as_datetime("2018-11-20 18:00:00"),
                     as_datetime("2018-11-23 12:00:00"))]


perfiles %>% 
  dcast(lev + date ~ exp, value.var = "T") %>% 
  .[, ":="(E5_E4 = E5 - E4,
           E6_E5 = E6 - E5,
           E7_E6 = E7 - E6)] %>% 
  melt(measure.vars = c("E5_E4", "E6_E5", "E7_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level))) +
  scale_fill_divergent_discretised(name = NULL,
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  labs(subtitle = "Temperature difference (K)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  # scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "24 hours") +
  facet_wrap(~variable, labeller = labeller(variable = c("E5_E4" = "AUT - CONV",
                                                         "E6_E5" = "SATWND - AUT",
                                                         "E7_E6" = "RAD - SATWND"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```


AUT-CONV present a negative difference in low levels with a clear diurnal cycle (Figure \@ref(fig:T-diff)). This negative difference indicate that AUT is warmer than CONV. It also shows significant differences in the upper levels of the troposphere during the hours of maximun convection. The temperature profiles of AUT y SATWND are very similar. The difference bewteen the two experiments is smaller than +-0.1 until Nov, 22th 00Z when the convection starts to develope on the domain. The differences between RAD y SATWIND (and AUT) are smaller important in low levels at the begining of the experiment and in upper levels at the end indicating that the satellite observations have impact in several levels. 

```{r T-mse, eval=FALSE, fig.cap="MSE", include=FALSE}

files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/derived_data/perfiles_mse*")

perfiles_mse <- purrr::map(files, function(f) {
  exp <- unglue(basename(f), "perfiles_{run}_{exp}.csv")
  fread(f) %>% 
    .[, run := exp[[1]][["run"]]] %>% 
    .[, exp := exp[[1]][["exp"]]] 
  
  
}) %>% 
  rbindlist() %>% 
  .[, date := as_datetime(date)] %>% 
  .[date %between% c(as_datetime("2018-11-20 20:00:00"),
                     as_datetime("2018-11-23 12:00:00"))]


perfiles_mse %>% 
  .[variable == "T"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = mse, fill = stat(level))) +
  scale_fill_viridis_c(option = "A", direction = -1,
                       name = NULL, super = ScaleDiscretised,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  labs(subtitle = "Temperature MSE (K^2)",
       x = NULL,
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "24 hours") +
  facet_wrap(~exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                               E6 = "SATWND", E7 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```



```{r Q-diff, fig.cap="Specific humidity difference between experiments in g/Kg"}
perfiles %>% 
  dcast(lev + date ~ exp, value.var = "QVAPOR") %>% 
  .[, ":="(E5_E4 = E5 - E4,
           E6_E5 = E6 - E5,
           E7_E6 = E7 - E5)] %>% 
  melt(measure.vars = c("E5_E4", "E6_E5", "E7_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value*1000, fill = stat(level)), 
                    breaks = c(seq(-1, 1.6, 0.2), Inf)) +
  scale_fill_divergent_discretised(name = NULL, limits = c(-1, 1.6),
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  labs(subtitle = "Specific humidity difference (g/Kg)",
       y = NULL,
       x = NULL) +
  facet_wrap(~variable, labeller = labeller(variable = c("E5_E4" = "AUT - CONV",
                                                         "E6_E5" = "SATWND - AUT",
                                                         "E7_E6" = "RAD - SATWND"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

Comparing the specific humidity (Figure \@ref(fig:Q-diff)) once again the difference between AUT and CONV is important in low levels showing the impact of assimilating the observations from automatic stations with larger spacial and temporal resolution. Between SATWND and AUT the differences are smaller and only important after Nov, 21st 18Z. The addition of satellite derived winds produce and increse of humidity around 750 hPa during Nov 21st (0.05 to 0.10 g/kg) and a decrese of humidity between surface and 750 hPa starting at 00Z Nov 22th until the end of the experiment.  

The differences between RAD and SATWND and therefore the impact of the radiances have opposite sign to the impact of the observations from automatic stations but with smaller magnituded in low levels. A positive difference can also be observed between 850 and 600 hPa. 
```{r Q-mse, eval=FALSE, fig.cap="MSE", include=FALSE}

perfiles_mse %>% 
  .[variable == "QVAPOR"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = mse*1000000, fill = stat(level))) +
  scale_fill_viridis_c(option = "A", direction = -1,
                       name = NULL, super = ScaleDiscretised,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  labs(subtitle = "Specific humidity MSE (g/Kg^2)",
       x = NULL,
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "24 hours") +
  facet_wrap(~exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                               E6 = "SATWND", E7 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r U-diff, fig.cap="Zonal wind difference between experiments in m/s (filled contours) and zonal wind profile for the experiment with more observations."}
perfiles %>% 
  dcast(lev + date ~ exp, value.var = "U") %>% 
  .[, ":="(E5_E4 = E5 - E4,
           E6_E5 = E6 - E5,
           E7_E6 = E7 - E6)] %>% 
  melt(measure.vars = c("E5_E4", "E6_E5", "E7_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), breaks = c(seq(-1.6, 2, 0.2), Inf)) +
  scale_fill_divergent_discretised(name = NULL,
                                   limits = c(-1.6, 2),
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  geom_contour2(data = ~.x[, .(lev, date, E5_E4 = E5, E6_E5 = E6, E7_E6 = E7)] %>% 
                  melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                breaks = seq(0, 30, 3), size = 0.2, linetype = 1, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E5_E4 = E5, E6_E5 = E6, E7_E6 =E7)] %>% 
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                    breaks = seq(0, 30, 3), color = "grey30", skip = 1, 
                    size = 4, stroke = 0.1) +
  labs(subtitle = "U difference (m/s)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, labeller = labeller(variable = c("E5_E4" = "AUT - CONV",
                                                         "E6_E5" = "SATWND - AUT",
                                                         "E7_E6" = "RAD - SATWND"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

In Figure \@ref(fig:U-diff) the difference between the experiments for the zonal wind is shown with the vertical profile for the experiment with more observations. For example the left panel shows the difference between AUT and CONV experiments and the profile wind for AUT. The wind profiles for the experiments are similar but there are important differences that can be seen on the filled contours. 

The differences between AUT and CONV are important in low levels, for the first two days the impact of assimilation observations from automatic stations is a disminution on the wind from the west but an increse of the wind from the west after Nov 22th, 18Z. In upper levels the sign of the impact varies throughout the experiment period. The assimilation of satellite derived winds produces an impact in midle and upper levels and the incorporation of radiances prodeces impacts on low and upper levels. In low levels the impact has the oposite sign comparing with AUT-CONV, this means that RAD experiment shows on average less westerly wind. 

```{r V-diff, fig.cap="Meridial wind difference between experiments in m/s"}
perfiles %>% 
  dcast(lev + date ~ exp, value.var = "V") %>% 
  .[, ":="(E5_E4 = E5 - E4,
           E6_E5 = E6 - E5,
           E7_E6 = E7 - E6)] %>% 
  melt(measure.vars = c("E5_E4", "E6_E5", "E7_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), 
                    breaks = c(-Inf, seq(-1.6, 1.2, 0.2), Inf)) +
  scale_fill_divergent_discretised(name = NULL, limits = c(-1.6, 1.2),
                                   guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.8)) +
  geom_contour2(data = ~.x[, .(lev, date, E5_E4 = E5, E6_E5 = E6, E7_E6 = E7)] %>% 
                  melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                breaks = seq(-9, 0, 1), size = 0.2, linetype = 2, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E5_E4 = E5, E6_E5 = E6, E7_E6 =E7)] %>% 
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value), 
                    breaks = seq(-9, 0, 1), color = "grey30", skip = 1, 
                    size = 4, stroke = 0.1) +
  labs(subtitle = "V difference (m/s)",
       x = NULL,
       y = NULL) +
  scale_y_level(breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, labeller = labeller(variable = c("E5_E4" = "AUT - CONV",
                                                         "E6_E5" = "SATWND - AUT",
                                                         "E7_E6" = "RAD - SATWND"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

Figure \@ref(fig:V-diff) is constructed in the same way as Figure \@ref(fig:U-diff) but here only negative meridional wind is ploted. Again the wind profiles are similar for each experiment but nevertheless there are differences of +- 1 m/s. 

In upper levels and during Nov 22nd and 23rd the impact of assimilating new observations (mainly from automatic stations and radiances) produces an increse of northerly wind. In low levels the impact has different sign in AUT-CONV and RAD-SATWND.


#### Low levels humidity

Specific humidity field averaged over the first 7 levels of the model, from surface to 800 hPa for low topography areas (aproximately). 

* AUT add humidity to the model (is correcting a dry model bias or modifing the circulation and transporting humidity from the north?)
* SATWND is not that different from AUT at list in low levels. The humidity is distributed a little bit different in the domain during 06Z
* RAD shows less humidity that AUT and SATWND but more than CONV. RAD seems to reverse (in part) the effect of incorporating automatic station observations in low levels. This can also be seeing in the first levels the difference between RAD and SATWND. 


```{r q-low, eval=FALSE, fig.align="center", message=FALSE, warning=FALSE, include=FALSE}
fcsts <- expand_grid(fcsts = c("20181121180000", "20181122000000", "20181122060000"),
                     exp = c("E4", "E5", "E6", "E7"))

q <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0(derived_data, "/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0(derived_data, "/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, q := ReadNetCDF(paste0(derived_data, "/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

q[bottom_top %between% c(0, 7), .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = q*1000, fill = stat(level_d)), proj = norargentina_lambert,
                    breaks = seq(0, 0.02, 0.002)*1000) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "BrBG", direction = 1,
                       limits = c(1, 19),
                       guide = guide_colorsteps(#inside = FALSE,
                         barwidth = 25,
                         barheight = 0.8)) +
  # geom_vector(aes(x = lon, y = lat,
  #                 dx = u, dy = v), data = function(x) x[is.cross(y, x, 8)],
  #             arrow.angle = 12, size = 0.3) +
  # scale_mag() +
  cordillera +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Low level humidity (g/Kg)",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```



```{r q-middle, eval=FALSE, include=FALSE}

q[bottom_top %between% c(8, 12), .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = q*1000, fill = stat(level_d)), proj = norargentina_lambert,
                    breaks = seq(0, 0.02, 0.002)*1000) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "BrBG", direction = 1,
                       limits = c(1, 19),
                       guide = guide_colorsteps(#inside = FALSE,
                         barwidth = 25,
                         barheight = 0.8)) +
  # geom_vector(aes(x = lon, y = lat,
  #                 dx = u, dy = v), data = function(x) x[is.cross(y, x, 8)],
  #             arrow.angle = 12, size = 0.3) +
  # scale_mag() +
  cordillera +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Humidity (g/Kg) 800-700 hPa",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```
```{r v-low, eval=FALSE, include=FALSE}
q[bottom_top %between% c(0, 7), .(v = mean(v)), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = v, fill = stat(level_d)), proj = norargentina_lambert) +
  scale_fill_divergent_discretised(name = NULL,
                                   # limits = c(1, 19),
                                   guide = guide_colorsteps(#inside = FALSE,
                                     barwidth = 25,
                                     barheight = 0.8)) +
  # geom_vector(aes(x = lon, y = lat,
  #                 dx = u, dy = v), data = function(x) x[is.cross(y, x, 8)],
  #             arrow.angle = 12, size = 0.3) +
  # scale_mag() +
  cordillera +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Low level meridional wind (m/s)",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r v-middle, eval=FALSE, include=FALSE}
q[bottom_top %between% c(8, 12), .(v = mean(v)), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = v, fill = stat(level_d)), proj = norargentina_lambert) +
  scale_fill_divergent_discretised(name = NULL,
                                   # limits = c(1, 19),
                                   guide = guide_colorsteps(#inside = FALSE,
                                     barwidth = 25,
                                     barheight = 0.8)) +
  # geom_vector(aes(x = lon, y = lat,
  #                 dx = u, dy = v), data = function(x) x[is.cross(y, x, 8)],
  #             arrow.angle = 12, size = 0.3) +
  # scale_mag() +
  cordillera +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "800-700 hPa meridional wind (m/s)",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```



```{r temp, eval=FALSE, include=FALSE}
fcsts <- expand_grid(fcsts = c("20181121180000", "20181122000000", "20181122060000"),
                     exp = c("E4", "E5", "E6", "E7"))

t <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0(derived_data, "/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0(derived_data, "/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, t := ReadNetCDF(paste0(derived_data, "/t_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(t = "temp"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

t[date == unique(date)[1:3] & west_east %between% c(70, 180)] %>% 
  .[, .(t_mean = mean(t),
        u_mean = mean(u),
        v_mean = mean(v)), by = .(bottom_top, south_north, date, exp)] %>% 
  .[, ":="(dir = atan2(v_mean, u_mean)*180/pi,
           mag = Mag(u_mean, v_mean))] %>%
  .[, date := factor(date)] %>% 
  ggplot(aes(south_north, bottom_top)) +
  geom_contour_fill(aes(z = t_mean, fill = stat(level_d))) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "OrRd", direction = 1,
                       # limits = c(1, 19),
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  # geom_contour(aes(z = v_mean, linetype = factor(-sign(..level..))), 
  #              color = "grey30", size = 0.3, binwidth = 2) +
  # geom_text_contour(aes(z = v_mean), color = "grey30", size = 4, stroke = 0.1, breaks = seq(-10, 6, 2)) +
  # scale_linetype(guide = NULL) +
  geom_arrow(aes(mag = mag, angle = dir),
             arrow.angle = 8, size = 0.2, skip.x = 10, skip.y = 3) +
  scale_mag() +
  facet_grid(date ~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                     E6 = "SATWND", E7 = "RAD"))) +
  labs(y =  "Sigma levels", x = "Grid points") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

```{r mucape, eval=FALSE, include=FALSE}
files <- Sys.glob(paste0(derived_data, "mucape/*")) 

files <- files[!str_detect(files, c("E3"))]

dates <- c("20181121180000", "20181122000000", "20181122060000")


mucape <- purrr::map(files, function(f) {
  details <- unglue::unglue(basename(f), "mcape_ana_{exp}_{date}.nc")[[1]]
  
  if (details$date %in% dates) {
    
    ReadNetCDF(f, vars = c(value = "cape_2d", lon = "XLONG", lat = "XLAT")) %>% 
      .[, `:=`(exp = details$exp, 
               date = lubridate::ymd_hms(details$date))] %>%
      setnames(old = "mcape_mcin_lcl_lfc", new = "variable") %>% 
      .[]
  }
}) %>% 
  rbindlist() 

mucape %>% 
  .[variable == "mcape"] %>% 
  # .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = value, fill = stat(level_d)), proj = norargentina_lambert) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "YlOrRd", direction = 1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  # cordillera +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Maximum CAPE",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))


```

```{r summary, fig.height=10, fig.width=10}
files <- Sys.glob(paste0(derived_data, "pw/*")) 
files <- files[!str_detect(files, c("E3"))]

dates <- c("20181122000000")


pw <- purrr::map(files, function(f) {
  details <- unglue::unglue(basename(f), "pw_ana_{exp}_{date}.nc")[[1]]
  
  if (details$date %in% dates) {
    
    ReadNetCDF(f, vars = c(value = "pw", lon = "XLONG", lat = "XLAT")) %>% 
      .[, `:=`(exp = details$exp, 
               date = lubridate::ymd_hms(details$date))] %>%
      .[]
  }
}) %>% 
  rbindlist() %>% 
  .[, c("x", "y") := wrf_project(lon, lat)]

files <- Sys.glob(paste0(derived_data, "mucape/*")) 
files <- files[!str_detect(files, c("E3"))]

mucape <- purrr::map(files, function(f) {
  details <- unglue::unglue(basename(f), "mcape_ana_{exp}_{date}.nc")[[1]]
  
  if (details$date %in% dates) {
    
    ReadNetCDF(f, vars = c(value = "cape_2d", lon = "XLONG", lat = "XLAT")) %>% 
      .[, `:=`(exp = details$exp, 
               date = lubridate::ymd_hms(details$date))] %>%
      setnames(old = "mcape_mcin_lcl_lfc", new = "variable") %>% 
      .[]
  }
}) %>% 
  rbindlist() 

fcsts <- expand_grid(fcsts = c("20181122000000"),
                     exp = c("E4", "E5", "E6", "E7"))

ana <- lapply(seq_len(nrow(fcsts)), function(f) {

  tmp <- ReadNetCDF(paste0(derived_data, "/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0(derived_data, "/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, q := ReadNetCDF(paste0(derived_data, "/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR"), out = "vector")] %>% 
    .[, theta := ReadNetCDF(paste0(derived_data, "/theta_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(th = "theta"), out = "vector")] %>%
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist() 

cor <- ana[bottom_top %in% c(2, 10)] %>% 
  dcast(date + exp + south_north + west_east ~ bottom_top, value.var = c("u", "v")) %>% 
  .[, cortante := Mag(u_10 - u_2, v_10 - v_2)] %>% 
  .[, ":="(u_2 = NULL, 
           u_10 = NULL,
           v_2 = NULL,
           v_10 = NULL)]

ana[bottom_top %between% c(2, 7), .(v_mean = mean(v)), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[pw, on = .NATURAL] %>% 
ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = value, fill = stat(level_d)),
                    proj = norargentina_lambert) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "YlGn", direction = 1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  geom_contour2(aes(z = v_mean, linetype = factor(-sign(v_mean))),
                proj = norargentina_lambert, color = "darkorange", 
                breaks = c(-10, -5, 0), size = 0.4) +
   geom_text_contour(aes(z = v_mean), size = 3, stroke = 0.05,
                     proj = norargentina_lambert, color = "darkorange", 
                breaks = c(-10, -5, 0), skip = 0,
                label.placement = label_placement_n(1)) +
  scale_linetype_manual(guide = NULL, values = c(2, 1)) +
  # cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +


ana[bottom_top %between% c(2, 10), .(theta_mean = mean(theta)), 
  by = .(south_north, west_east, date, exp)] %>% 
   .[pw, on = .NATURAL] %>% 
ggplot(aes(x, y)) +
 # geom_point(aes(color = v_mean)) +
  geom_contour_fill(aes(z = theta_mean, fill = stat(level_d)),
                    proj = norargentina_lambert,
                    breaks = c(-Inf, seq(290, 314, 2), Inf), limits = c(-Inf, Inf)) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "RdYlBu", direction = -1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  # cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.text = element_blank(), 
        strip.background = element_blank()) +


mucape %>% 
  .[variable == "mcape"] %>% 
  .[, c("x", "y") := wrf_project(lon, lat)] %>% 
  .[cor, on = .NATURAL] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = value, fill = stat(level_d)), 
                    proj = norargentina_lambert, limits = c(500, 6000)) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "YlOrRd", direction = 1,
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  # geom_contour2(aes(z = cortante),
  #               proj = norargentina_lambert, color = "black", size = 0.4,
  #               breaks = c(10, 25)) +
  geom_point(data = ~.x[cortante >= 10 & is.cross(x, y, skip = 1)], 
             aes(x = lon, y = lat, 
                 alpha = factor(cut_round(cortante, breaks = c(5, 15, 40)))),
             size = 0.00002, shape = 20) +
  scale_alpha_manual(values = c(0.3, 0.7), guide = NULL) +
  # cordillera +
  geom_mapa() +
  facet_grid(. ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                         E6 = "SATWND", E7 = "RAD"))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        # legend.box.spacing = margin(1, 1, 1, 1),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.text = element_blank(), 
        strip.background = element_blank()) +
  
    plot_layout(ncol = 1, heights = c(1, 1, 1))
```


```{r}
coord <- mucape[variable == "mcape", c("south_north", "lat")] %>% 
  .[, .(lat = mean(lat)), by = south_north]

ana[west_east %between% c(70, 180)] %>% 
  .[, .(q_mean = mean(q),
        v_mean = mean(v)), by = .(bottom_top, south_north, date, exp)] %>% 
  coord[., on = "south_north"] %>% 
  ggplot(aes(lat, bottom_top)) +
  geom_contour_fill(aes(z = q_mean*1000, fill = stat(level_d))) +
  scale_fill_distiller(name = NULL, super = ScaleDiscretised,
                       palette = "BrBG", direction = 1,
                       # limits = c(1, 19),
                       guide = guide_colorsteps(barwidth = 25,
                                                barheight = 0.8)) +
  geom_contour2(aes(z = v_mean, linetype = factor(-sign(..level..))), 
               color = "grey30", size = 0.3, binwidth = 2) +
  geom_text_contour(aes(z = v_mean), color = "grey30", 
                    size = 3, stroke = 0.05, breaks = seq(-10, 6, 2)) +
  scale_linetype(guide = NULL) +
  scale_x_latitude(breaks = seq(-40, -20, 5)) +
  facet_wrap( ~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                     E6 = "SATWND", E7 = "RAD"))) +
  labs(y =  "Sigma levels") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```

Is the analysis correcting a dry bias on the model or the humidity is being transported into the domain?

The innovation (OmB) for surface humidity observations is mainly positive indicating that the model has in general less humidity than the atmosfere throghout the domain for a specific cycle. 

```{r omb-q, fig.cap="Observation minus guess for humidity surface observations during Nov, 21st 18Z"}

exp <- c("E4", "E5", "E6", "E7")

q_field <- purrr::map(exp, function(f) {  
  f
  read_diag_conv(paste0("/home/paola.corrales/datosmunin/EXP/", f,
                        "/ANA/20181121180000/diagfiles/asim_conv_20181121180000.ensmean"), 
                 exp = f, member = "000", variable = c("q"))
}) %>% rbindlist()


q_field[usage.flag == 1 & type %in% c(181, 187) & obs.guess < 0.02] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_mapa(fill = "grey90") +
  geom_point(aes(color = obs.guess)) +
  scale_color_divergent(guide = guide_colorbar(barwidth = 25,
                                               barheight = 0.8)) +
  
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~exp, ncol = 4, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                         E6 = "SATWND", E7 = "RAD"))) +
  labs(x = NULL, y = NULL, color = "OmB") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

```

```{r omb-t, fig.cap="Observation minus guess for humidity surface observations during Nov, 21st 18Z"}

exp <- c("E4", "E5", "E6", "E7")

q_field <- purrr::map(exp, function(f) {  
  f
  read_diag_conv(paste0("/home/paola.corrales/datosmunin/EXP/", f,
                        "/ANA/20181121180000/diagfiles/asim_conv_20181121180000.ensmean"), 
                 exp = f, member = "000", variable = c("t"))
}) %>% rbindlist()


q_field[usage.flag == 1 & type %in% c(181, 187) & abs(obs.guess) < 15] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_mapa(fill = "grey90") +
  geom_point(aes(color = obs.guess)) +
  scale_color_divergent(guide = guide_colorbar(barwidth = 25,
                                               barheight = 0.8)) +
  
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~exp, ncol = 4, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                         E6 = "SATWND", E7 = "RAD"))) +
  labs(x = NULL, y = NULL, color = "OmB") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

```


The evolution of the mean of the absolute OmB is always positive for all four experiments, AUT and SATWND showing higher values follow by RAD. The size of the points shows that AUT, SATWND and RAD assimilate more observations.

This result is indicating that the model has an important dry bias and the assimilation of high temporal and spatial resolution observations are correcting this. 

TODO: it's the same for all PBL parameterizations? 

```{r omb-q-evol, eval=FALSE, fig.cap="Evolution", include=FALSE}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E[4-7]/ANA/*/diagfiles/asim_conv_201811*.ensmean")

conv <- purrr::map(files, function(f) {  
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/{exp}/ANA/{date}/diagfiles/asim_conv_{date_ana}.ensmean")
  read_diag_conv(f, exp = meta[[1]][["exp"]], member = "000", variable = c("q")) %>% 
    .[stationID %in% oficiales$stationID] %>% 
    .[]
}) %>% rbindlist()


conv[type %in% c(181, 187) & exp %in% c("E5", "E7") & usage.flag == 1, 
     .(mean_omb = mean(obs.guess, na.rm = TRUE),
       n = .N), 
     by = .(date, exp, usage.flag)] %>% 
  ggplot(aes(date, mean_omb)) +
  geom_line(aes(color = exp)) +
  geom_point(aes(color = exp, size = n)) +
  scale_size_area(max_size = 2) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  # facet_wrap(~usage.flag, labeller = labeller(usage.flag = c("1" =  "assimilated",
  #                                                            "-1" = "rejected"))) +
  scale_date(20181120180000, 20181123120000) +
  labs(y = "Mean of OmB (g/g)", x = NULL,
       color = NULL, size = "number\n of obs") +
  theme_minimal()

rm(conv)

# conv[usage.flag == 1 & type %in% c(181, 187) & exp %in% experiments] %>% 
#   ggplot(aes(date, obs.guess)) +
#   geom_point(aes(color = exp, group = date), alpha = 0.1) +
# scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
#                                           E6 = "SATWND", E7 = "RAD")) +
#   geom_smooth() +
#   facet_wrap(~exp) +
#   labs(y = "Mean of OmB (g/g)", x = NULL,
#        color = NULL, size = "n obs") +
#   theme_minimal()
# ,
#      .(n = .N), 
#      by = .(date, exp)] %>% 
#   ggplot(aes(date, n)) +
#   geom_line(aes(color = exp)) +
#   # geom_point(aes(color = exp, size = n)) +
#   # scale_size_area(max_size = 3) +
#   scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
#                                           E6 = "SATWND", E7 = "RAD")) +
#   labs(y = "Mean of OmB (g/g)", x = NULL,
#        color = NULL, size = "n obs") +
#   theme_minimal()

```

```{r omb-q-evol-param, eval=FALSE, fig.cap="Evolution", include=FALSE}
files <- c(Sys.glob("~/datosmunin/EXP/E5/ANA/*/diagfiles/asim_conv_201811*.mem*"),
           Sys.glob("~/datosmunin/EXP/E7/ANA/*/diagfiles/asim_conv_201811*.mem*"))

conv <- purrr::map(files, function(f) {  
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/{exp}/ANA/{date}/diagfiles/asim_conv_{date_ana}.mem{mem}")
  read_diag_conv(f, exp = meta[[1]][["exp"]], member = meta[[1]][["mem"]], variable = c("q")) %>% 
    .[stationID %in% oficiales$stationID] %>% 
    .[]
}) %>% rbindlist() %>% 
  fisica[., on = "mem"] %>% 
  separate(fisica,  into = c("conv", "pbl"))

conv[type %in% c(181, 187) & exp %in% c("E5", "E7") & usage.flag == 1, 
     .(mean_omb = mean(obs.guess, na.rm = TRUE),
       n = .N), 
     by = .(date, exp, pbl, usage.flag)] %>% 
  ggplot(aes(date, mean_omb)) +
  geom_line(aes(color = exp, linetype = pbl)) +
  geom_point(aes(color = exp, size = n/60)) +
  scale_size_area(max_size = 2) +
  scale_linetype_manual(values = c(2, 1, 4)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  # facet_wrap(~usage.flag, labeller = labeller(usage.flag = c("1" =  "assimilated",
  #                                                            "-1" = "rejected"))) +
  scale_date(20181120180000, 20181123120000) +
  labs(y = "Mean of OmB (g/g)", x = NULL, linetype = NULL,
       color = NULL, size = "number\n of obs") +
  theme_minimal()

rm(conv)
```

The negative difference between RAD and SATWND in low levels (\@ref(fig:Q-diff)) and positive values over those levels can be explain by a deeper boundary layer. To explore this posibility Figure \@ref(fig:pbl-18Z) shows the zonal mean high of the PBL over the subdomain estimated for the PBL parameterization for Nov 21st, 18Z. The mean is calculated over a big area with different hights than can altered the result but but still the hight of the boundary layer for RAD is greater than in the other experiments in many areas.


```{r pbl-18Z, eval=FALSE, fig.cap="Zonal mean high of the PBL over the subdomain estimated for the PBL parameterization for Nov 21st", include=FALSE}
pblh18 <- purrr::map(exp, function(f) {
  
  ReadNetCDF(paste0("/home/paola.corrales/datosmunin/EXP/", f, "/ANA/20181121180000/analysis.ensmean"), 
             vars = c("PBLH", lon = "XLONG", lat = "XLAT"),
             subset = list(south_north = c(41, 119),
                           west_east = c(96, 143))) %>% 
    .[, c("x", "y") := wrf_project(lon, lat)] %>% 
    .[, exp := f]
  
}) %>% 
  rbindlist()


pblh18[lat %between% c(-38.5, -20.8) & lon %between% c(-67, -54)] %>% 
  .[, .(mean = mean(PBLH)), by = .(exp, south_north)] %>% 
  ggplot(aes(south_north, mean)) +
  geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  labs(x = "Grid points (south - north)", y = "mean PBLH (m)", color = NULL) +
  theme_minimal()
```


If the average is calculated over a smaller domain to avoid hight terrain and water, it is posible to see the evolution of the PBL hight during the experiment (Figure \@ref(fig:pblh-evol)). In CONV and RAD the PBL is higher during the diurnal hours of Nov, 21st with, exceeding AUT and SATWND by about 200 meters. These hours coincide with the time when the highest humidity above 800 hPa in RAD is observed. After that, the behavior chances and the development of the convection over the domain starts to affect the PBL. 

The deeper PBL in RAD can explain the transport of humidity to higher levels. This efect does not appear in CONV because there is no much humidity to transport to upper levels. 

TODO: Are there RAD observations on those levels to explain the humidity besides the transport from low levels? 

```{r pblh, eval=FALSE, fig.cap="", include=FALSE}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E[4-7]/ANA/*/analysis.ensmean")

pblh <- purrr::map(files, function(f) {
  meta <- unglue(f, "/home/paola.corrales/datosmunin/EXP/{exp}/ANA/{date}/analysis.ensmean")
  
  ReadNetCDF(paste0(f), 
             vars = c("PBLH", lon = "XLONG", lat = "XLAT"),
             subset = list(south_north = c(41, 119),
                           west_east = c(96, 143))) %>% 
    .[, c("x", "y") := wrf_project(lon, lat)] %>% 
    .[, exp := meta[[1]][["exp"]]] %>% 
    .[, date := ymd_hms(meta[[1]][["date"]])]
  
}) %>% 
  rbindlist()

# pblh[lat %between% c(-38, -31) & lon %between% c(-64, -59)] %>%
#   ggplot(aes(x, y)) +
#   geom_contour_fill(aes(z =  PBLH), proj = norargentina_lambert,
#                     breaks = seq(0, 5000, 500)) +
#   scale_fill_viridis_b(breaks = seq(0, 5000, 500)) +
#   geom_mapa() +
#   facet_wrap(~ exp) +
#   theme_minimal()

pblh[, .(mean = mean(PBLH)), by = .(exp, date)] %>% 
  ggplot(aes(date, mean)) +
  geom_line(aes(color = exp)) +
  geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  labs(x = NULL, y = "mean PBLH (m)", color = NULL) +
  theme_minimal()
```

### Verification

```{r pp-hov, fig.cap="Hövmoller of hourly acumulated precipitation (for ensemble mean) over the inner domain."}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/derived_data/ppacum/*ana*mean*")

ppacum_1h <- purrr::map(files, function(f) {
  
  readRDS(f) %>% 
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)]
  
}) %>% rbindlist() %>% 
  .[x %between% c(-300000, 800000) & y %between% c(-800000, 1090000)] 


readRDS("/home/paola.corrales/mesoda/analysis/data/derived_data/IMERG_1h.rds") %>% 
  .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
  .[x %between% c(-300000, 800000) & y %between% c(-800000, 1090000)] %>% 
  .[end_date %between% c(as_datetime("20181120190000"), as_datetime("20181123120000"))] %>% 
  .[, .(pp_acum = mean(pp_acum),
        lat = mean(lat),
        exp = "IMERG"), by = .(end_date, y)] %>% 
  ggplot(aes(end_date, lat)) +
  geom_contour2(aes(z = pp_acum, color = ..level..), 
               breaks = seq(1, 15, 1)) +
  scale_color_viridis_c(guide = NULL, breaks = seq(1, 14, 1), limits = c(1, 15)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  scale_y_latitude(breaks = seq(-40, -20, 5)) +
  facet_wrap(~ exp) +
  labs(x = NULL, y = NULL, color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  ppacum_1h %>% 
  .[, lat := lat[1], by = .(y)] %>% 
  .[, .(pp_acum = mean(pp_acum)), by = .(exp, date, y, lat)] %>% 
  ggplot(aes(date, lat)) +
  # geom_raster(aes(fill = pp_acum)) +
  geom_contour2(aes(z = pp_acum, color = ..level..),
               breaks = seq(1, 15, 1)) +
  scale_color_viridis_c(breaks = seq(1, 15, 1), limits = c(1, 15),
                        guide = guide_colorstrip(inside = TRUE,
                                                 barwidth = 25,
                                                 barheight = 0.8)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  scale_y_latitude(breaks = seq(-40, -20, 5)) +
  facet_wrap(~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                E6 = "SATWND", E7 = "RAD"))) +
  labs(x = NULL, y = NULL, color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  plot_layout(ncol = 2, widths = c(0.4, 0.6), guides = "collect") & theme(legend.position = 'bottom')
```

```{r eval=FALSE, include=FALSE}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/derived_data/ppacum/*ana*prop*")

ppacum_1h <- purrr::map(files, function(f) {
  
  readRDS(f)
  
}) %>% rbindlist() %>% 
  .[x %between% c(-300000, 800000) & y %between% c(-800000, 1090000)]

ppacum_1h %>% 
  .[, .(prop = mean(prop)), by = .(exp, date, y, umbral)] %>% 
  .[umbral %in% c(1, 5)] %>% 
  ggplot(aes(date, y)) +
  geom_contour_fill(aes(z = prop*100, fill = stat(level_d)),
                    breaks = seq(0, 100, 10)) +
  scale_fill_gradientn(colours = rev(Redmonder::redmonder.pal(10, name = "qMSOStd")),
                       limits = c(10, 100),
                       na.value = "white",
                       super = ScaleDiscretised,
                       # breaks = seq(0, 100, 10),
                       guide = guide_colorsteps(barwidth = 15,
                                                barheight = 1)) +
  # scale_color_viridis_c() +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(umbral ~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                       E6 = "SATWND", E7 = "RAD"),
                                               umbral = c("1" = "1 mm/h",
                                                          "5" = "5 mm/h"))) +
  labs(fill = "", x = "", y = "") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### Reflectivity

```{r dbz-mean}

dates <- rep(c("20181122100000", "20181122220000"), 1, each = 4)
files <- paste0(derived_data, "dbz/maxdbz_ana_", experiments, "_", dates, ".nc")

dbz <- purrr::map(files, function(f){
  
  meta <- unglue(basename(f), "maxdbz_ana_{exp}_{date}.nc")
  ReadNetCDF(f, vars = c(lon = "XLONG", lat = "XLAT", "max_dbz")) %>% 
    .[, ":="(exp = meta[[1]][["exp"]],
             date = ymd_hms(meta[[1]][["date"]]))] %>% 
    .[, c("x", "y") := wrf_project(lon, lat)] 
}) %>% 
  rbindlist()


dbz %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = max_dbz, fill = stat(level_d)), 
                    proj = norargentina_lambert,
                    breaks = seq(0, 60, 5),) +
  scale_color_dbz(aesthetics = "fill", super = ScaleDiscretised, 
                  guide = guide_colorsteps(barwidth = 0.8, 
                                           barheight = 20)) +
  geom_mapa() +
  facet_grid(date~exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                   E6 = "SATWND", E7 = "RAD"))) +
  labs(x = NULL, y = NULL, fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r dbz-ens, fig.height=10, fig.width=7}

files <- Sys.glob(paste0(derived_data, "dbz/maxdbz_ana_E[4-7]_0*"))
files <- files[str_detect(files, "20181122000000", negate = TRUE)]

dbz <- purrr::map(files, function(f){
  
  meta <- unglue(basename(f), "maxdbz_ana_{exp}_{mem}_{date}.nc")
  ReadNetCDF(f, vars = c(lon = "XLONG", lat = "XLAT", "max_dbz")) %>% 
    .[, ":="(exp = meta[[1]][["exp"]],
             mem = meta[[1]][["mem"]],
             date = ymd_hms(meta[[1]][["date"]]))] %>% 
    .[, c("x", "y") := wrf_project(lon, lat)] 
}) %>% 
  rbindlist() %>% 
  fisica[., on = "mem"] %>% 
  separate(fisica, into = c("cumulus", "pbl"))


  dbz %>% 
  .[, .(max_dbz = mean(max_dbz, na.rm = TRUE)), by = .(cumulus, exp, date, lon, lat, x, y)] %>% 
    .[date %in% unique(date)[1:2]] %>% 
    .[, date := factor(date)] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = max_dbz, fill = stat(level_d)), 
                    proj = norargentina_lambert,
                    breaks = seq(0, 60, 5),) +
  scale_color_dbz(aesthetics = "fill", super = ScaleDiscretised, 
                  guide = guide_colorsteps(barheight = 0.8, 
                                           barwidth = 20)) +
  geom_mapa() +
  ggh4x::facet_nested(date + cumulus ~ exp, 
                      labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                   E6 = "SATWND", E7 = "RAD"))) +
  labs(fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.box.spacing = margin(0, 0, 0, 0),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
  
  rm(dbz)
```
#### FSS for the analysis


```{r}
files <- Sys.glob("/home/paola.corrales/mesoda/analysis/data/derived_data/fss_6h_ana_ens_E[4-7]new.csv")

fss <- purrr::map(files, function(f) {
  
  fread(f) %>% 
    .[, date := as_datetime(date)]
}) %>% 
  rbindlist()



fss %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  # geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  scale_date(20181121000000, 20181123000000, "12 hours") +
  facet_grid(w~q, labeller = labeller(q = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"),
                                      w = c("5" = "50 km", "11" = "100 km", 
                                            "51" = "500 km", "101" = "1000 km"))) +
  labs(color = NULL, x = NULL, y = "FSS") +
  theme_minimal()

```
#### Soundings



```{r message=FALSE, warning=FALSE}
files <- Sys.glob("/home/paola.corrales/datosmunin/EXP/E*/ANA/sondeos/*")

sondeos <- purrr::map(files, function(f){
  
  fread(f) %>% 
    .[, value := fifelse(variable %in% c("t", "td"), value + 273.15, value)] %>% 
    .[, launch_time := as_datetime(launch_time)]
  
}) %>% 
  rbindlist()

IOP <- tribble(
  ~iop, ~ini, ~end,
  "IOP07", ymd_hms("20181121150000"), ymd_hms("20181121210000"),
  "IOP08", ymd_hms("20181122140000"), ymd_hms("20181122200000")
) %>% setDT()



sondeos %>% 
  .[, iop := fcase(launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")), "IOP07",
                   launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")), "IOP08")] %>% 
  .[variable == "t" & !str_detect(site, "/") & !is.na(fcst_value) & !is.na(iop)] %>% 
  .[, oma := value - fcst_value] %>% 
  # melt(measure.vars = c("value", "oma"), variable.name = "var") %>%  
  ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = oma), size = 0.5) +
  scale_color_divergent() +
  # geom_contour(aes(z = value - fcst_value)) +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  # scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  facet_grid(exp ~ iop, scales = "free_x", labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                                       E6 = "SATWND", E7 = "RAD"))) +
  labs(color = "OmA", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  sondeos %>% 
  .[, iop := fcase(launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")), "IOP07",
                   launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")), "IOP08")] %>% 
  .[variable == "v" & !str_detect(site, "/") & !is.na(fcst_value) & !is.na(iop)] %>% 
  .[, oma := value - fcst_value] %>% 
  # melt(measure.vars = c("value", "oma"), variable.name = "var") %>%  
  ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = oma), size = 0.5) +
  scale_color_divergent() +
  # geom_contour(aes(z = value - fcst_value)) +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  # scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  facet_grid(exp ~ iop, scales = "free_x", labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                                                       E6 = "SATWND", E7 = "RAD"))) +
  labs(color = "OmA", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  plot_layout(ncol = 2, widths = c(0.5, 0.5))
```

```{r}

sondeos %>% 
  .[, iop := fcase(launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")), "IOP07",
                   launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")), "IOP08")] %>% 
  .[variable %in% c("t", "td", "u", "v") & !str_detect(site, "/") & !is.na(fcst_value) & !is.na(iop)] %>% 
  .[, lev := cut_round(alt, seq(0, 20000, 1000))] %>% 
  .[, ":="(RMSE = mean(sqrt((value - fcst_value)^2), na.rm = TRUE), 
           BIAS = mean(value - fcst_value, na.rm = TRUE)), by = .(iop, exp, variable, lev)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est") %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  coord_flip() +
  facet_grid(iop~variable, scales = "free_x", 
             labeller = labeller(variable = c("t" = "Temperature",
                                              "td" = "Dew point\ntemperature",
                                              "u" = "U wind",
                                              "v" = "V wind"))) +
  labs(y = NULL, x = "Height (Km)", color = NULL, linetype = NULL) +
  theme_minimal()
```


```{r}
sondeos %>% 
  .[variable == "td" & !str_detect(site, "/") & 
      exp == "E4"] %>%
ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = value), size = 0.5) +
  scale_color_distiller(palette = "YlOrRd", direction = 1) +
  # geom_contour(aes(z = value - fcst_value)) +
  scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  labs(color = "Td", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  sondeos %>% 
  .[variable == "td" & !str_detect(site, "/") & !is.na(fcst_value)] %>% 
  .[, oma := value - fcst_value] %>% 
  # melt(measure.vars = c("value", "oma"), variable.name = "var") %>%  
  ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = oma), size = 0.5) +
  scale_color_divergent() +
  # geom_contour(aes(z = value - fcst_value)) +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  facet_wrap(~exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                               E6 = "SATWND", E7 = "RAD"))) +
  labs(color = "OmA", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  plot_layout(ncol = 2, widths = c(0.3, 0.7))
```


```{r}
sondeos %>% 
  .[variable == "v" & !str_detect(site, "/") & 
      exp == "E4"] %>% 
  ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = value), size = 0.5) +
  scale_color_divergent() +
  # geom_contour(aes(z = value - fcst_value)) +
  scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  labs(color = "V (m/s)", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  sondeos %>% 
  .[variable == "v" & !str_detect(site, "/") & !is.na(fcst_value)] %>% 
  .[, oma := value - fcst_value] %>% 
  # melt(measure.vars = c("value", "oma"), variable.name = "var") %>%  
  ggplot(aes(launch_time, alt/1000)) +
  geom_point(aes(color = oma), size = 0.5) +
  scale_color_divergent() +
  # geom_contour(aes(z = value - fcst_value)) +
  coord_cartesian(ylim = c(0, 20), expand = c(0, 0)) +
  scale_x_datetime(date_breaks = "12 hours", date_labels = "%b %d \n %H%M") +
  facet_wrap(~exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", 
                                               E6 = "SATWND", E7 = "RAD"))) +
  labs(color = "OmA", y = NULL, x = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
  plot_layout(ncol = 2, widths = c(0.3, 0.7))
```



### Forecast


```{r}
files <- Sys.glob("/home/paola.corrales/mesoda/analysis/data/derived_data/fss_6h_fcst_*_E[4-7]new.csv")

fss <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "fss_6h_fcst_{ini_date}_{exp}new.csv")
  
  fread(f) %>% 
    .[, date := as_datetime(date)] %>% 
    .[, ini_date := ymd_h(meta[[1]][["ini_date"]])]
}) %>% 
  rbindlist()

fss %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  # geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E4 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E7 = "RAD")) +
  facet_grid(w~q, labeller = labeller(q = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"),
                                      w = c("5" = "50 km", "11" = "100 km", 
                                            "51" = "500 km", "101" = "1000 km"))) +
  labs(color = NULL, x = NULL, linetype = NULL) +
  theme_minimal()

```


